<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Clinton Campbell">
        <link rel="canonical" href="https://info314.tcpip.dev/resources/netfilter-hooks/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Understanding Netfilter/Iptables Hooks - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/pi-setup/">Raspberry Pi Setup</a>
</li>
            
<li >
    <a href="../../assignments/networkd-setup/">networkd Setup</a>
</li>
            
<li >
    <a href="../wifi-reference/">Wifi Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../address-planning/">IP Address Planning Reference</a>
</li>
            
<li >
    <a href="../../assignments/dhcp-setup/">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/router-setup/">Router Setup</a>
</li>
            
<li >
    <a href="../iptables/">Introduction to iptables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/resolver-setup/">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Report - NAT and DNS Analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/analysis-report/">Instructions</a>
</li>
            
<li >
    <a href="../tshark-install/">Installing TShark</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">5 - Configure an Authoritative Name Server</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/dns-zone-setup/">Authoritative Zone Setup</a>
</li>
            
<li >
    <a href="../zone-file-format/">DNS Zone Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Extra Credit</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/vlan-challenge/">VLAN Challenge</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../assignments/lab1/">Lab 1 - Core Technical Skills</a>
</li>
                                    
<li >
    <a href="../../assignments/lab2/">Lab 2 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li >
    <a href="../../assignments/lab3/">Lab 3 - Analyze Zeroconf in Wireshark</a>
</li>
                                    
<li >
    <a href="../../assignments/lab4/">Lab 4 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li >
    <a href="../../assignments/lab5/">Lab 5 - Analyze TCP with ncat and Wireshark</a>
</li>
                                    
<li >
    <a href="../../assignments/lab6/">Lab 6 - Python and Socket Basics</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Proxy Labs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../assignments/proxy-labs/">Proxy Project Overview</a>
</li>
            
<li >
    <a href="../../assignments/lab7/">Proxy Part 1 (Lab 7)</a>
</li>
            
<li >
    <a href="../../assignments/lab8/">Proxy Part 2 (Lab 8)</a>
</li>
            
<li >
    <a href="../../assignments/lab9/">Proxy Part 3 (Lab 9)</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Getting Started</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../pi-materials/">Getting Pi Materials</a>
</li>
            
<li >
    <a href="../digital-ocean/">Digital Ocean Signup</a>
</li>
            
<li >
    <a href="../markdown/">Intro to Markdown</a>
</li>
            
<li >
    <a href="../bash/">Intro to Bash</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../notes/dns-overview/">Domain Name System (DNS)</a>
</li>
            
<li >
    <a href="../../notes/router-overview/">Routers</a>
</li>
            
<li >
    <a href="../../notes/ethernet-switches/">Ethernet Switches</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Guides</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Common Tools</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../ssh-agent/">Using ssh-agent</a>
</li>
            
<li >
    <a href="../wireshark-install/">Install Wireshark</a>
</li>
            
<li >
    <a href="../tshark-install/">Install TShark</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">DNS</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../zone-file-format/">Zone File Reference</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">General Network Configuration</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../wifi-reference/">Linux Wireless Configuration</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Iptables</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../iptables/">Introduction to Iptables</a>
</li>
            
<li class="active">
    <a href="./">Understanding Netfilter/Iptables Hooks</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Planning</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../address-planning/">Basic IP Address Planning</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Routing and VPNs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../setup-frr/">Install Free Range Routing (FRR)</a>
</li>
            
<li >
    <a href="../setup-wireguard/">Install and Configure WireGuard</a>
</li>
            
<li >
    <a href="../configure-routing-links/">Configuring Routing Links</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Special Network Interfaces</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../loopback-interfaces/">Loopback Interfaces</a>
</li>
            
<li >
    <a href="../dummy-interfaces/">Dummy Interfaces</a>
</li>
            
<li >
    <a href="../vlan-interfaces/">VLAN Interfaces</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Troubleshooting</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../host-config/">Mac/Win/Linux Networking</a>
</li>
            
<li >
    <a href="../manage-dhcp/">Troubleshooting DHCP</a>
</li>
            
<li >
    <a href="../dns-clients/">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../contact/">Contact Us</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../iptables/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../address-planning/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/quirktree/info314-website">quirktree/info314-website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#understanding-netfilteriptables-hooks">Understanding Netfilter/Iptables Hooks</a></li>
            <li><a href="#working-with-local-traffic">Working with Local Traffic</a></li>
            <li><a href="#working-with-routed-traffic">Working with Routed Traffic</a></li>
            <li><a href="#summary">Summary</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="understanding-netfilteriptables-hooks">Understanding Netfilter/Iptables Hooks<a class="headerlink" href="#understanding-netfilteriptables-hooks" title="Permanent link">&para;</a></h1>
<p>The <em>netfilter</em> component of Linux defines a set of <em>hooks</em> within the TCP/IP stack that are used to run code based on different packet events at different moments in the packet lifecycle. Utilities like iptables (and more recently nftables) provide a frontend and language for managing rules and actions that we want to perform based on the characteristics of network traffic. These tools are commonly used to implement services like NAT or to provide host or network-based packet filtering firewalls.</p>
<h2 id="working-with-local-traffic">Working with Local Traffic<a class="headerlink" href="#working-with-local-traffic" title="Permanent link">&para;</a></h2>
<p>To better understand how all of this works, let’s start with a simplified example on a standard Linux host. For now, ignore the possibility of routing and focus on the host’s ability to send or receive packets. In this scenario, we can use netfilter for tasks like dropping unwanted traffic or rewriting addresses and layer-3 ports on the fly.</p>
<p>Since this is a simplified scenario, we can limit our examination to two hooks, INPUT and OUTPUT, that are triggered for packets flowing to and from the local device in a non-routing scenario. By non-routing, we mean that the INPUT hook is only invoked when the host is the intended recipient of the message based on the packet’s destination IP address. Likewise, the OUTPUT hook won’t fire unless the message originated from the local host. Given the INPUT/OUTPUT hooks, we can use a frontend like iptables to register specific rules and actions that are evaluated for each packet passing through the network stack.</p>
<h3 id="host-based-packet-filters">Host-based Packet Filters<a class="headerlink" href="#host-based-packet-filters" title="Permanent link">&para;</a></h3>
<p>One of the most common applications of the INPUT/OUTPUT hooks is to perform packet filtering in order to provide a host-based firewall for the Linux device. For example, from a security perspective, we typically want to limit how much of an “attack surface” we expose over the network. We can leverage the INPUT hook to drop packets that aren’t part of a TCP connection that we had previously initiated. In other words, we allow client-based software to open outbound connections but we block any attempts to connect to us as a server. If we need more flexibility, we can create rules to allow connections in to specific services, such as an HTTP or SSH daemon. </p>
<h2 id="working-with-routed-traffic">Working with Routed Traffic<a class="headerlink" href="#working-with-routed-traffic" title="Permanent link">&para;</a></h2>
<p>Netfilter operations become slightly more complex when routing is introduced. Like an ordinary host, routers still process packets coming to/from the local device, but they also need to forward packets received on one network interface through other interfaces. In fact, this latter operation is their main responsibility. In order to support these communication paths, netfilter defines three additional hooks: FORWARD, PREROUTING, and POSTROUTING that we can use to perform network-based packet filtering, network address translation (NAT), and other packet-level operations.</p>
<h3 id="network-based-packet-filters">Network-based Packet Filters<a class="headerlink" href="#network-based-packet-filters" title="Permanent link">&para;</a></h3>
<p>For packet-filtering purposes, the FORWARD hook is a direct analogue for the INPUT/OUTPUT hooks. As we’ve mentioned, INPUT/OUTPUT are not applied to routed packets. Instead, code registered on the FORWARD hook will be evaluated after the initial routing decision is made. The FORWARD hook provides the basis for network-based firewall functionality. Network-based firewalls enable us to drop or reject unwanted traffic before it has the opportunity to reach our hosts (or even enter into the network). Likewise, we can also leverage packet filtering to prevent certain types of local traffic from inadvertently leaking outside our own network perimeters.</p>
<h3 id="network-address-translation">Network Address Translation<a class="headerlink" href="#network-address-translation" title="Permanent link">&para;</a></h3>
<p>Sometimes it makes more sense to perform an action for an incoming packet before any routing decision has been made or just before actually sending an outgoing packet. This is the case for port and network address translation and is facilitated by attaching rules to the PREROUTING and POSTROUTING hooks. Specifically, we set up rules on the PREROUTING hook when we want to modify incoming packets based on their destination IP address. This configuration is called destination NAT (DNAT) and is useful for delivering traffic to a server on a private subnet. Likewise, we use the POSTROUTING hook when our goal is to change outgoing packets based on the original source address. This configuration is called source NAT (SNAT) and is useful when we need map a public IP on to packets coming from private addresses. </p>
<h3 id="additional-caveats-for-local-traffic">Additional Caveats for Local Traffic<a class="headerlink" href="#additional-caveats-for-local-traffic" title="Permanent link">&para;</a></h3>
<p>Unlike the FORWARD hook, PREROUTING and POSTROUTING may be used for local traffic as well as routed traffic. In particular, an incoming packet will be processed by the PREROUTING hook before the network stack makes a routing decision and reaches the INPUT hook. For outgoing packets, the OUTPUT hook is invoked prior to the outbound routing/forwarding decision or the POSTROUTING hook. For local traffic, we often have a choice about which hook provides the best entry point for our rules. </p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>When you're first learning about Linux networking internals, it can be difficult to remember the relationship between netfilter hooks and related events in the packet lifecycle. The following list summarizes what we've learned so far in terms of specific traffic flows. </p>
<ul>
<li>Incoming local traffic: (receive packet via network interface) -&gt; PREROUTING -&gt; (local routing decision) -&gt; INPUT -&gt; (continue processing packet and deliver via sockets)</li>
<li>Outgoing local traffic: (receive packet via sockets) -&gt; OUTPUT -&gt; (outbound routing) -&gt; POSTROUTING -&gt; (continue processing and send via network interface)</li>
<li>Routed traffic: (receive packet via network interface) -&gt; PREROUTING -&gt; (inbound routing) -&gt; FORWARD -&gt; (outbound routing) -&gt; POSTROUTING -&gt; (continue processing and send via network interface)</li>
</ul>
<p>As you work to digest each of these traffic flows, you can refer to the following list for a reminder of which operations can be performed by using a particular hook. Once again, we are distinguishing routed traffic from incoming and outgoing routed traffic.</p>
<ul>
<li>Filtering incoming traffic to local: INPUT</li>
<li>Filtering outgoing traffic from local: OUTPUT</li>
<li>Filtering routed traffic (in any direction): FORWARD</li>
<li>SNAT for routed traffic: POSTROUTING</li>
<li>SNAT for outgoing local traffic: POSTROUTING or OUTPUT</li>
<li>DNAT for routed traffic: PREROUTING</li>
<li>DNAT for incoming local traffic: PREROUTING or INPUT</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 Clinton Campbell</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
