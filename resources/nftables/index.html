<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Clinton Campbell">
        <link rel="canonical" href="https://info314.tcpip.dev/resources/nftables/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Introduction to nftables - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/color-brewer.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/pi-setup/" class="dropdown-item">Raspberry Pi Setup</a>
</li>
            
<li>
    <a href="../wifi-reference/" class="dropdown-item">Wireless Configuration Reference</a>
</li>
            
<li>
    <a href="../uw-wireless/" class="dropdown-item">UW Wireless Reference</a>
</li>
            
<li>
    <a href="../../assignments/networkd-setup/" class="dropdown-item">networkd Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../address-planning/" class="dropdown-item">IP Address Planning Reference</a>
</li>
            
<li>
    <a href="../../assignments/dhcp-setup/" class="dropdown-item">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/router-setup/" class="dropdown-item">Router Setup</a>
</li>
            
<li>
    <a href="./" class="dropdown-item">Introduction to nftables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/resolver-setup/" class="dropdown-item">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Report - NAT and DNS Analysis</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/analysis-report/" class="dropdown-item">Instructions</a>
</li>
            
<li>
    <a href="../tshark-install/" class="dropdown-item">Installing TShark</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">5 - Configure an Authoritative Name Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/dns-zone-setup/" class="dropdown-item">Authoritative Zone Setup</a>
</li>
            
<li>
    <a href="../zone-file-format/" class="dropdown-item">DNS Zone Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Extra Credit</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="/" class="dropdown-item">VLAN Challenge</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../assignments/wireshark01/" class="dropdown-item">Lab 1 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li>
    <a href="../../assignments/wireshark02/" class="dropdown-item">Lab 2 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li>
    <a href="../../assignments/wireshark03/" class="dropdown-item">Lab 3 - Analyze Zeroconf in Wireshark</a>
</li>
                                    
<li>
    <a href="../../assignments/wireshark04/" class="dropdown-item">Lab 4 - Analyze TCP with ncat and Wireshark</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Getting Started</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../markdown/" class="dropdown-item">Intro to Markdown</a>
</li>
            
<li>
    <a href="../bash/" class="dropdown-item">Intro to Bash</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../address-planning/" class="dropdown-item">Basic IP Address Planning</a>
</li>
            
<li>
    <a href="../../notes/dns-overview/" class="dropdown-item">Domain Name System (DNS)</a>
</li>
            
<li>
    <a href="../zone-file-format/" class="dropdown-item">DNS Zone Files</a>
</li>
            
<li>
    <a href="../../notes/ethernet-switches/" class="dropdown-item">Ethernet Switches</a>
</li>
            
<li>
    <a href="../../notes/router-overview/" class="dropdown-item">Routers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Core Settings and Tools</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ssh-primer/" class="dropdown-item">Getting Started with SSH</a>
</li>
            
<li>
    <a href="../ssh-agent/" class="dropdown-item">Using the SSH Agent</a>
</li>
            
<li>
    <a href="../wireshark-install/" class="dropdown-item">Install Wireshark</a>
</li>
            
<li>
    <a href="../tshark-install/" class="dropdown-item">Install TShark</a>
</li>
            
<li>
    <a href="../host-config/" class="dropdown-item">Mac/Win/Linux Networking</a>
</li>
            
<li>
    <a href="../manage-dhcp/" class="dropdown-item">Troubleshooting DHCP</a>
</li>
            
<li>
    <a href="../dns-clients/" class="dropdown-item">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">General Linux Networking</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Firewalls</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active">Introduction to nftables</a>
</li>
            
<li>
    <a href="../netfilter-hooks/" class="dropdown-item">Understanding netfilter Hooks</a>
</li>
            
<li>
    <a href="../iptables/" class="dropdown-item">Introduction to iptables</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Network Interfaces</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../loopback-interfaces/" class="dropdown-item">Loopback Interfaces</a>
</li>
            
<li>
    <a href="../dummy-interfaces/" class="dropdown-item">Dummy Interfaces</a>
</li>
            
<li>
    <a href="../vlan-interfaces/" class="dropdown-item">VLAN Interfaces</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Virtual Private Networking</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../setup-wireguard/" class="dropdown-item">Install and Configure WireGuard</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Wireless</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../wifi-reference/" class="dropdown-item">wpa_supplicant Reference</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Free Range Routing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../setup-frr/" class="dropdown-item">Install Free Range Routing (FRR)</a>
</li>
            
<li>
    <a href="../configure-routing-links/" class="dropdown-item">Configuring Routing Links</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">University of Washington Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../uw-wireless/" class="dropdown-item">UW Wireless Network Reference</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../dns-clients/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../netfilter-hooks/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/quirktree/info314-website" class="nav-link">quirktree/info314-website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#introduction-to-netfilter-and-nftables-2022-04-02" class="nav-link">Introduction to netfilter and nftables (2022-04-02)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#what-is-nftables" class="nav-link">What is nftables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#tables-chains-and-rule-syntax" class="nav-link">Tables, Chains, and Rule Syntax</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#configuring-nftables" class="nav-link">Configuring nftables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#resources" class="nav-link">Resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="introduction-to-netfilter-and-nftables-2022-04-02">Introduction to netfilter and nftables (2022-04-02)<a class="headerlink" href="#introduction-to-netfilter-and-nftables-2022-04-02" title="Permanent link">&para;</a></h1>
<p>This guide introduces nftables by building a basic ruleset that allows us to safely forward packets between internal and external networks while also masquerading traffic with the IP address of the external network interface. </p>
<p><em>Read the entire guide carefully before attempting to install the template or any of the other tools referenced here</em>.</p>
<h2 id="what-is-nftables">What is nftables<a class="headerlink" href="#what-is-nftables" title="Permanent link">&para;</a></h2>
<p><em>nftables</em> is the default tool used to manage netfilter's <em>packet filter rules</em> in Raspberry Pi OS. Though <em>nftables</em> was originally released in 2014, it did not make its way into Raspberry Pi OS until the Bullseye release in November 2021. <em>nftables</em> is the successor to <em>iptables</em>, which has been in use within the Linux community for more than 20 years.</p>
<p><em>nftables</em> is a packet filtering framework included in a variety of modern Linux implementations. <em>Packet filtering</em> is a powerful technique that enables administrators to analyze and control the flow of inbound and outbound network traffic from any endpoint or intermediate network node. This level of control is essential for host- and network-based firewalls, network address translation (NAT), and other applications.</p>
<p>Packet filters define rules to match traffic based primarily on Layer 2 - 4 properties, such as: the inbound or outbound interface, type and length of messages, addresses, ports, and connection state. Each filter also describes actions taken when a match is found, e.g., log, deliver, or drop the packet. netfilter-based packet filters can also be used to apply NAT, make decisions about Quality of Service, or to reroute packets mid-flight.</p>
<p><em>nftables</em> builds on <em>netfilter</em>, an open-source project adding hooks, connection tracking, and other capabilities to the Linux network stack. These components enable dynamic filters, like <em>nftables</em> rules, to be applied to every packet traversing the network stack. They are the secret sauce to many of the applications described above. </p>
<h2 id="tables-chains-and-rule-syntax">Tables, Chains, and Rule Syntax<a class="headerlink" href="#tables-chains-and-rule-syntax" title="Permanent link">&para;</a></h2>
<p>In <em>nftables</em>, rules are composed of <em>expressions</em> that are used to select packets and <em>statements</em> that determine what actions <em>netfilter</em> will perform when a match occurs. While rules are the meat of our filter configurations, <em>nftables</em> doesn't allow them to stand alone. And so, before we explore the rule syntax, we need to looks <em>tables</em> and <em>chains</em>. </p>
<h3 id="tables">Tables<a class="headerlink" href="#tables" title="Permanent link">&para;</a></h3>
<p><em>nftables</em> uses a basic structure known as a <em>table</em> to organize rules. Each <em>table</em> is associated with a single <em>address family</em> and includes rules to apply to packets of that family. </p>
<p>This guide is focused on layer-3 traffic and considers tables for the following three address families:</p>
<ul>
<li><code>ip</code>: for IPv4 rules (default)</li>
<li><code>ip6</code>: for IPv6 rules</li>
<li><code>inet</code>: for rules that apply to both IPv4 and IPv6 packets</li>
</ul>
<p>While its predecessor, <em>iptables</em>, included a default set of tables for common packet filter functionality, <em>nftables</em> administrators are left to define their own tables. For this exercise, we'll create an IPv4 <code>nat</code> table to implement <em>address translation</em> between private and public addresses and an IPv4/IPv6 <code>filter</code> table to protect the Pi and the rest of our LAN from malicious traffic.<sup id="fnref:table_names"><a class="footnote-ref" href="#fn:table_names">1</a></sup></p>
<div class="admonition example">
<p class="admonition-title">Example: Empty <em>filter</em> and <em>nat</em> tables</p>
<div class="annotate highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain"># Define chains (and rules) for IPv4 or IPv6 packets</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="l l-Scalar l-Scalar-Plain">table ip nat {</span><span class="w"></span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain"># Define chains (and rules) for IPv4 packets</span><span class="w"></span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<h3 id="chains">Chains<a class="headerlink" href="#chains" title="Permanent link">&para;</a></h3>
<p>Within each table, rules are grouped in <em>chains</em>. A <em>chain</em> is an ordered list of rules describing the packets to match and the action to take when a match is found. When a chain is processed, the rules in it are tested in order from the beginning until a match is found. If <em>nftables</em> finds a match while evaluating a rule, the remaining rules in that chain may be skipped depending on what action is taken.</p>
<h4 id="base-chains">Base Chains<a class="headerlink" href="#base-chains" title="Permanent link">&para;</a></h4>
<p><em>nftables</em> won't evaluate the rules in a chain automatically. Rather, a chain will only be processed if it is explicitly called from a rule in another chain or if the chain has been associated with a <a href="/resources/netfilter-hooks"><em>netfilter hook</em></a>.A chain that is associated with a hook is called a <em>base chain</em>.</p>
<p>Within the <code>filter</code> table, we are going to work with three base chains named <code>input</code>, <code>output</code>, and <code>forward</code>. These chains will be associated with <em>filter</em> hooks of the same names<sup id="fnref:chain_names"><a class="footnote-ref" href="#fn:chain_names">2</a></sup>, causing them to be processed when packets are being sent to software running on the Pi (<code>input</code> hook), when packets are being sent out by software on the Pi (<code>output</code>) hook, or when packets are being routed by the Pi from one network to another (<code>forward</code> hook). </p>
<div class="admonition example">
<p class="admonition-title">Example: Filter table and empty base chains</p>
<div class="annotate highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain input {</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook input priority 0;</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># Rules are evaluated when a packet is intended for this host</span><span class="w"></span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0;</span><span class="w"></span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># Rules are evaluated when an incoming packet will be forwarded by this host</span><span class="w"></span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain output {</span><span class="w"></span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook output priority 0;</span><span class="w"></span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># Rules are evaluated when a packet is being sent from this host</span><span class="w"></span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <code>nat</code> table will have one base chain that is named for its respective <em>hook</em>, i.e., <code>postrouting</code>. Within netfilter, the postrouting hooks are the last ones to be processed when sending or forwarding a packet. As such, rules processed here can perform masquerading on the source IP addresses.<sup id="fnref:prerouting"><a class="footnote-ref" href="#fn:prerouting">3</a></sup></p>
<div class="admonition example">
<p class="admonition-title">Example: NAT with postrouting base chain</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>table ip nat {
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    chain postrouting {
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>        type nat hook postrouting priority 100;
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>        # Rules are evaluated after forwarding decisions in order to support source NAT or masquerading
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    }
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>}
</code></pre></div>
</div>
<h3 id="rules-syntax">Rules Syntax<a class="headerlink" href="#rules-syntax" title="Permanent link">&para;</a></h3>
<p>The basic <em>nftables</em> rule syntax includes an expression and a statement. Expressions define conditions that need to be satisfied before an action is applied to a packet. Statements define the actions that will be taken. Since actions are the simpler component of a rule, we'll begin our exploration there. </p>
<h4 id="statements-actions">Statements (actions)<a class="headerlink" href="#statements-actions" title="Permanent link">&para;</a></h4>
<p><em>nftables</em> statements are used to control packet flow, apply <em>NAT</em> transformations, compute metrics, record logs, and modify the order of rule evaluation. While the list below is not exhaustive, it is sufficient for this guide and the beginning firewall developer.</p>
<ul>
<li><a href="https://wiki.nftables.org/wiki-nftables/index.php/Accepting_and_dropping_packets"><code>accept</code></a>: Stop processing chain and deliver packet</li>
<li><a href="https://wiki.nftables.org/wiki-nftables/index.php/Accepting_and_dropping_packets"><code>drop</code></a>: Stop processing chain and drop packet</li>
<li><a href="https://wiki.nftables.org/wiki-nftables/index.php/Counters"><code>counter</code></a>: Increment byte and packet counters and continue processing chain</li>
<li><a href="https://wiki.nftables.org/wiki-nftables/index.php/Logging_traffic"><code>log</code></a>: Write information about packet to logs and continue processing chain</li>
<li><a href="https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)#Masquerading"><code>masquerade</code></a>: Replace source IP address with the address of the output interface and stop processing chain</li>
</ul>
<p>You may observe that actions like <code>drop</code> and <code>accept</code> cause <em>nftables</em> to stop processing the current chain. These actions are known as terminal actions. Actions like <code>log</code> and <code>counter</code> are non-terminal because they allow <em>nftables</em> to continue processing even if a match had been found. <em>nftables</em> supports multiple actions in a single statement, but a terminal may only appear as the final component of a rule. </p>
<p>For example, we can produce a rule that increments a counter and delivers a packet by ending our rule with <code>counter accept</code>. We can also write a rule that increments a counter and logs a packet without specifying a policy decision by ending the rule with <code>counter log</code> or <code>log counter</code>. However, we cannot combine terminals or include a terminal before a non-terminal as with <code>accept counter</code> or <code>drop accept</code>.</p>
<h4 id="expressions-conditions">Expressions (conditions)<a class="headerlink" href="#expressions-conditions" title="Permanent link">&para;</a></h4>
<p>Our rules need to describe the packets we want to filter or manipulate. In this exercise, our <em>primary consideration</em> will be the <em>direction</em> in which a given packet is moving through the Pi. This is particularly of importance for routing decisions and NAT. We can describe our criteria by examining the ingress network for incoming packets and/or the egress network interface for outgoing packets. </p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Throughout the instructions, we'll refer to the internal interface as our <strong>&lt;LAN&gt;</strong> (because it serves our local network) and the external interface as the <strong>&lt;WAN&gt;</strong> (because it connects us to the Internet). Your configuration files will reflect the system assigned interface names, such as: <strong><code>eth0</code></strong> and <strong><code>wlan0</code></strong>.</p>
<p>It's up to you to determine, based on your learning so far, which interface corresponds to which placeholder.</p>
</div>
<p>Let's look at a rule that we can use to apply address translation to outbound packets. Since outbound packets will leave on the WAN, we can specify this restriction using the <em>outbound interface name (oifname)</em> condition, i.e., <code>oifname &lt;WAN&gt;</code>. The following example masquerades outbound traffic on the <strong>&lt;WAN&gt;</strong> interface.</p>
<div class="admonition example">
<p class="admonition-title">Example: Applying NAT transformation to outbound traffic</p>
<div class="annotate highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="l l-Scalar l-Scalar-Plain">table ip nat {</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain postrouting {</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type nat hook postrouting priority srcnat;</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">oifname &lt;WAN&gt; masquerade</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can be even more specific with our rules by writing an expression with multiple conditionals. To identify outbound traffic forwarded from the LAN to the WAN, we can check both the inbound and outbound interface names by writing <code>iifname &lt;LAN&gt; oifname &lt;WAN&gt;</code>. The following example demonstrates a rule that explicitly accepts traffic flowing from <strong>&lt;LAN&gt;</strong> to <strong>&lt;WAN&gt;</strong>.</p>
<div class="admonition example">
<p class="admonition-title">Example: Combining multiple expressions</p>
<div class="annotate highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0;</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;LAN&gt; oifname &lt;WAN&gt; accept</span><span class="w"></span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<h5 id="using-connection-state-in-rules">Using Connection State in Rules<a class="headerlink" href="#using-connection-state-in-rules" title="Permanent link">&para;</a></h5>
<p>Netfilter is a <em>stateful</em> filtering framework, meaning that it is even possible to specify nftables rules based on the state of a network connection for a given packet. This feature shapes our rules in two ways. </p>
<p>First, you'll notice that we only had to specify the masquerade rule in the egress direction. The same rule also handles the de-masquerading process for ingress packets. </p>
<p>Second, you'll see that we can base filtering decisions on connection state itself. While it's appropriate for NAT routers to allow outgoing traffic, we typically want to place restrict incoming traffic. When configuring a gateway connection for a home or office, we often block incoming traffic unless it relates to existing connections from the LAN. Unsolicited traffic does not make sense in this context and poses a security risk.</p>
<p>To accomplish this feat, we will make use of netfilter's connection tracking extensions and restrict incoming traffic to packets that are part of an established connection or related to a recent egress packet. The connection tracking portion of this expression is <code>ct state established,related</code>. </p>
<div class="admonition example">
<p class="admonition-title">Example: Using the connection tracking extension</p>
<div class="annotate highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0;</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;WAN&gt; ct state established,related accept</span><span class="w"></span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<h4 id="default-policy-for-base-chains">Default Policy (for Base Chains)<a class="headerlink" href="#default-policy-for-base-chains" title="Permanent link">&para;</a></h4>
<p>We are missing one piece to complete our configuration. By default, <em>nftables</em> accepts a packet unless a match occurs on a terminal rule. Base chains can override this behavior by defining a default policy. We'll use this feature to create a firewall that fail securely, i.e., blocking traffic that we don't explicitly allow.</p>
<p>The following example adds a base chain policy in order to drop forwarded packets that we didn't allow from another rule.</p>
<div class="admonition example">
<p class="admonition-title">Example: Default drop policy</p>
<div class="annotate highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0; policy drop;</span><span class="w"></span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># Explicitly allow &quot;safe&quot; connections</span><span class="w"></span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;LAN&gt; oifname &lt;WAN&gt; accept</span><span class="w"></span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;WAN&gt; ct state established,related accept</span><span class="w"></span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <em>default deny</em> posture is a best practice for your networks and devices, but it's important to approach the strategy with care. Without additional rules, attaching <code>policy drop</code> to the <code>input</code> and <code>output</code> chains will block inbound and outbound SSH and other protocols that might be needed for remote management. We will come back to this in a later guide, but we recommend for now that you leave the default accept policy on these chains.</p>
<h3 id="final-nat-template">Final NAT Template<a class="headerlink" href="#final-nat-template" title="Permanent link">&para;</a></h3>
<p>The following template draws together all of the components we have discussed so far to define a basic NAT configuration for a Linux router, leaving placeholder<sup id="fnref:placeholder"><a class="footnote-ref" href="#fn:placeholder">4</a></sup>,<sup id="fnref:quoting"><a class="footnote-ref" href="#fn:quoting">5</a></sup> elements for the reader to complete. Please review the previous examples and specifications that have been given in order to create a valid configuration. The following section will help you test and install your new ruleset.</p>
<p>!!! info Routing / NAT template
    <div class="annotate highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Always flush the active ruleset before defining your new rules</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="l l-Scalar l-Scalar-Plain">flush ruleset</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook &lt;HOOK&gt; priority 0; policy &lt;ACTION&gt;;</span><span class="w"></span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># Explicitly allow &quot;safe&quot; connections</span><span class="w"></span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;LAN&gt; oifname &lt;WAN&gt; &lt;ACTION&gt;</span><span class="w"></span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;WAN&gt; ct state established,related &lt;ACTION&gt;</span><span class="w"></span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain input {</span><span class="w"></span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook input priority 0;</span><span class="w"></span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># You may leave this chain empty for now</span><span class="w"></span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain output {</span><span class="w"></span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook output priority 0;</span><span class="w"></span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain"># You may leave this chain empty for now</span><span class="w"></span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="l l-Scalar l-Scalar-Plain">table ip nat {</span><span class="w"></span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain postrouting {</span><span class="w"></span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type nat hook postrouting priority srcnat;</span><span class="w"></span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">oifname &lt;WAN&gt; masquerade</span><span class="w"></span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div></p>
<h2 id="configuring-nftables">Configuring nftables<a class="headerlink" href="#configuring-nftables" title="Permanent link">&para;</a></h2>
<p>Throughout this guide, <em>nftables</em> configuration has been presented in a declarative, table-based format that closely reflects the table/chain/rule hierarchy. <em>nftables</em> also supports a command-based syntax that is passed to the <em>nft</em> utility on the command line or from within scripts in order to create, read, update, and delete individual elements of a ruleset dynamically. </p>
<p>We generally want firewall and routing rules to be configured as soon as possible during the boot process. When the <em>nftables</em> service is started, <em>Raspberry Pi OS</em> will initialize it with the contents of <em>/etc/nftables.conf</em>. </p>
<p>While experimentation is usually encouraged, you may encounter negative consequences if you make haphazard modifications to this file. A <a href="#editing-nftable-rules-safely">simple script</a> is provided below to support the learning process by testing your ruleset before making changes permanent.</p>
<h3 id="enable-the-nftables-service">Enable the nftables Service<a class="headerlink" href="#enable-the-nftables-service" title="Permanent link">&para;</a></h3>
<p>The <em>nftables</em> service may not be running by default on your device. You can check on the current status of the daemon with <code>systemctl status nftables</code>. To launch the service immediately, run <code>systemctl start nftables</code>. To ensure that <em>nftables</em> also starts automatically at boot, run <code>systemctl enable nftables</code>. </p>
<h3 id="editing-nftable-rules-safely">Editing nftable Rules Safely<a class="headerlink" href="#editing-nftable-rules-safely" title="Permanent link">&para;</a></h3>
<div class="admonition danger">
<p class="admonition-title">Here be Dragons</p>
<p>Do not write rules directly to <code>/etc/nftables.conf</code>. Without proper testing, you risk creating a rule that locks you out of your device from the network.  </p>
</div>
<p>Create a working copy of <code>/etc/nftables.conf</code> into your <em>home directory</em> <em>(it is okay to rename the file)</em>. Open the new copy and ensure that <code>flush ruleset</code> near the top (before your table definitions).<sup id="fnref:flush"><a class="footnote-ref" href="#fn:flush">6</a></sup> Proceed with any modifications to the working copy.</p>
<p>To test your ruleset, we recommend a scripted approach that can automatically revert a change that locks you out of the Pi. INFO314 students can find a copy of <code>nftables-apply.sh</code> in the project repository or create the script from the following listing.</p>
<details class="info">
<summary>nftables-apply.sh</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>#!/bin/bash
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a># Adapted from https://sanjuroe.dev/nft-safe-reload (retrieved on 2022-04-03)
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a># Modified to avoid editing system rules in-place
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>SYSTEM_RULES=&quot;/etc/nftables.conf&quot;
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>TIMEOUT=45
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>saved_rules=$(mktemp)
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>cleanup() {
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    rm -f &quot;$saved_rules&quot;
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>}
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>trap &quot;cleanup&quot; EXIT;
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a># Waits $TIMEOUT seconds for a yes/no response
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>read_approval() {
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        read -t $TIMEOUT response 2&gt; /dev/null
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>        case &quot;$response&quot; in
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>                y|Y)
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>                        return 0
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>                        ;;
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>                *)
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>                        return 1
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>                        ;;
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>        esac
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>}
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a># Make a copy of the active ruleset
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>backup() {
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        printf &quot;flush ruleset\n&quot; &gt; $saved_rules
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>        nft list ruleset &gt;&gt; $saved_rules
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>}
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a># Apply a named ruleset
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>apply() {
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>        nft -f &quot;$1&quot;
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>}
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a># Update system ruleset
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>save() {
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>    local source_rules=&quot;$1&quot;
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>    cp --no-preserve=mode,ownership &quot;$source_rules&quot; &quot;$SYSTEM_RULES&quot;
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>}
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a># Make a backup of the active ruleset in case of rollback
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>backup
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>new_rules=&quot;$1&quot;
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>if apply &quot;$new_rules&quot;; then
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>    printf &quot;Are you still able to connect to your device (auto-rollback in $TIMEOUT seconds)? [y/n] &quot;
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>        if read_approval; then
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>        save &quot;$new_rules&quot;
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>                printf &quot;\nUpdated system ruleset at ${SYSTEM_RULES}\n&quot;
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>        exit 0
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>        else
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>                apply &quot;$saved_rules&quot;
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>        printf &quot;\nRolling back to original configuration\n&quot;
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>                exit 2
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>        fi
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>fi
</code></pre></div>
</details>
<p>To test your rules, pass the name of your new rules file to the <em>nftables-apply.sh</em> script, e.g., <code>./nftables-apply.sh nftables-test.conf</code>. If your rules load without any errors, you will be prompted to answer whether you can still connect. </p>
<p>Open an <em>additional</em> terminal window and launch SSH to connect to your Pi. If you are able to complete this step successfully, you can apply your changes to <code>/etc/nftables.conf</code> by answering <code>y</code> at the <em>nftables-apply</em> prompt in your original session. </p>
<p><img alt="Accept New Rules" src="/img/accept-nft-rules.png" /></p>
<p>If the test fails, answer <strong>n</strong> or wait 45 seconds for the rules to revert automatically.</p>
<p><img alt="Reject New Rules" src="/img/rollback-nft-rules.png" /></p>
<p>Once you are satisified that your rules are working correctly, it's a good idea to verify that your rules are loaded and that everything works correctly after a reboot. Use the <code>nft list ruleset</code> command to view active rules.</p>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="/resources/netfilter-hooks">Understanding Netfilter Hooks</a></li>
<li><a href="https://www.datapacket.com/blog/securing-your-server-with-nftables">Securing Your Server with nftables</a></li>
<li><a href="https://sanjuroe.dev/nft-safe-reload">Safe Reload with nftables</a></li>
<li><a href="https://www.oreilly.com/openbook/linag2/book/ch11.html">Linux Network Administrators Guide - Masquerading</a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:table_names">
<p>These names were chosen to mirror the built-in tables of <em>iptables</em>.&#160;<a class="footnote-backref" href="#fnref:table_names" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:chain_names">
<p>This naming convention is influenced by <em>iptables</em> and its built-in chains.&#160;<a class="footnote-backref" href="#fnref:chain_names" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:prerouting">
<p><em>netfilter</em> also defines a <code>prerouting</code> nat hook that executes before routing decisions and can be used to implement port-forwarding and other destination NAT configurations.&#160;<a class="footnote-backref" href="#fnref:prerouting" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:placeholder">
<p>Text surrounded by &lt;&gt; symbols is indicative of a placeholder that should be filled in before loading the ruleset.&#160;<a class="footnote-backref" href="#fnref:placeholder" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:quoting">
<p>Do not quote text substituted for placeholders unless quotes are shown in the template.&#160;<a class="footnote-backref" href="#fnref:quoting" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:flush">
<p><code>nft -f &lt;FILENAME&gt;</code> is additive by default. Including <code>flush ruleset</code> before your table/chain definitions ensures that the new ruleset is properly loaded.&#160;<a class="footnote-backref" href="#fnref:flush" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2022 Clinton Campbell</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
