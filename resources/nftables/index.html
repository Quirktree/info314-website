
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation and Resources for INFO 314">
      
      
        <meta name="author" content="Clinton Campbell">
      
      
        <link rel="canonical" href="https://info314.tcpip.dev/resources/nftables/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.7">
    
    
      
        <title>Introduction to netfilter and nftables (2022-04-02) - INFO 314 Course Resources</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.9d5733d3.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction-to-netfilter-and-nftables-2022-04-02" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="INFO 314 Course Resources" class="md-header__button md-logo" aria-label="INFO 314 Course Resources" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            INFO 314 Course Resources
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Introduction to netfilter and nftables (2022-04-02)
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/quirktree/info314-website" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    quirktree/info314-website
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../assignments/pi-setup/" class="md-tabs__link">
        Projects
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../assignments/wireshark01/" class="md-tabs__link">
        Labs
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../markdown/" class="md-tabs__link">
        Resources
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../contact/" class="md-tabs__link">
      Contact Us
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="INFO 314 Course Resources" class="md-nav__button md-logo" aria-label="INFO 314 Course Resources" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    INFO 314 Course Resources
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/quirktree/info314-website" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    quirktree/info314-website
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Projects
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Projects" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Projects
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          1 - Pi Setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="1 - Pi Setup" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          1 - Pi Setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/pi-setup/" class="md-nav__link">
        Raspberry Pi Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/networkd-setup/" class="md-nav__link">
        networkd Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../wifi-reference/" class="md-nav__link">
        Wireless Configuration Reference
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../uw-wireless/" class="md-nav__link">
        UW Wireless Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          2 - Set up a DHCP Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="2 - Set up a DHCP Server" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          2 - Set up a DHCP Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../address-planning/" class="md-nav__link">
        IP Address Planning Reference
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/dhcp-setup/" class="md-nav__link">
        Installing and Configuring the ISC DHCP Server
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          3 - Configure Routing and NAT
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="3 - Configure Routing and NAT" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          3 - Configure Routing and NAT
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/router-setup/" class="md-nav__link">
        Router Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../iptables/" class="md-nav__link">
        Introduction to iptables
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          4 - Configure a DNS Resolver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="4 - Configure a DNS Resolver" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          4 - Configure a DNS Resolver
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/resolver-setup/" class="md-nav__link">
        DNS Resolver Setup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          Report - NAT and DNS Analysis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Report - NAT and DNS Analysis" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Report - NAT and DNS Analysis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/analysis-report/" class="md-nav__link">
        Instructions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tshark-install/" class="md-nav__link">
        Installing TShark
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_6">
          5 - Configure an Authoritative Name Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="5 - Configure an Authoritative Name Server" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          5 - Configure an Authoritative Name Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/dns-zone-setup/" class="md-nav__link">
        Authoritative Zone Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../zone-file-format/" class="md-nav__link">
        DNS Zone Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/wireshark01/" class="md-nav__link">
        Lab 1 - Analyzing DHCP and ARP with Wireshark
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/wireshark02/" class="md-nav__link">
        Lab 2 - Analyze DNS & HTTP in Wireshark
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assignments/wireshark03/" class="md-nav__link">
        Lab 3 - Analyze Zeroconf in Wireshark
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Resources
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Resources" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Resources
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../markdown/" class="md-nav__link">
        Intro to Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bash/" class="md-nav__link">
        Intro to Bash
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Concepts and Theory
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Concepts and Theory" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Concepts and Theory
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/dns-overview/" class="md-nav__link">
        Domain Name System (DNS)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/router-overview/" class="md-nav__link">
        Routers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../notes/ethernet-switches/" class="md-nav__link">
        Ethernet Switches
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1" type="checkbox" id="__nav_4_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_1">
          Common Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Common Tools" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_1">
          <span class="md-nav__icon md-icon"></span>
          Common Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ssh-primer/" class="md-nav__link">
        Getting Started with SSH
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ssh-agent/" class="md-nav__link">
        Using ssh-agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../wireshark-install/" class="md-nav__link">
        Install Wireshark
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tshark-install/" class="md-nav__link">
        Install TShark
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_2" type="checkbox" id="__nav_4_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_2">
          DNS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DNS" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_2">
          <span class="md-nav__icon md-icon"></span>
          DNS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../zone-file-format/" class="md-nav__link">
        Zone File Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_3" type="checkbox" id="__nav_4_3_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_3">
          Wireless
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Wireless" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_3">
          <span class="md-nav__icon md-icon"></span>
          Wireless
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../wifi-reference/" class="md-nav__link">
        Linux Wireless Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../uw-wireless/" class="md-nav__link">
        UW Wireless Network Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4" type="checkbox" id="__nav_4_3_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_4">
          Iptables
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Iptables" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_4">
          <span class="md-nav__icon md-icon"></span>
          Iptables
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../iptables/" class="md-nav__link">
        Introduction to Iptables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../netfilter-hooks/" class="md-nav__link">
        Understanding Netfilter/Iptables Hooks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_5" type="checkbox" id="__nav_4_3_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_5">
          Planning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Planning" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_5">
          <span class="md-nav__icon md-icon"></span>
          Planning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../address-planning/" class="md-nav__link">
        Basic IP Address Planning
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_6" type="checkbox" id="__nav_4_3_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_6">
          Routing and VPNs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Routing and VPNs" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_6">
          <span class="md-nav__icon md-icon"></span>
          Routing and VPNs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../setup-frr/" class="md-nav__link">
        Install Free Range Routing (FRR)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../setup-wireguard/" class="md-nav__link">
        Install and Configure WireGuard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configure-routing-links/" class="md-nav__link">
        Configuring Routing Links
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_7" type="checkbox" id="__nav_4_3_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_7">
          Special Network Interfaces
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Special Network Interfaces" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_7">
          <span class="md-nav__icon md-icon"></span>
          Special Network Interfaces
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../loopback-interfaces/" class="md-nav__link">
        Loopback Interfaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dummy-interfaces/" class="md-nav__link">
        Dummy Interfaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../vlan-interfaces/" class="md-nav__link">
        VLAN Interfaces
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          General
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="General" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          General
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../host-config/" class="md-nav__link">
        Mac/Win/Linux Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../manage-dhcp/" class="md-nav__link">
        Troubleshooting DHCP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dns-clients/" class="md-nav__link">
        Managing DNS Clients
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../contact/" class="md-nav__link">
        Contact Us
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-nftables" class="md-nav__link">
    What is nftables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nftables-configuration" class="md-nav__link">
    nftables Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tables-chains-and-rule-syntax" class="md-nav__link">
    Tables, Chains, and Rule Syntax
  </a>
  
    <nav class="md-nav" aria-label="Tables, Chains, and Rule Syntax">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tables" class="md-nav__link">
    Tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chains" class="md-nav__link">
    Chains
  </a>
  
    <nav class="md-nav" aria-label="Chains">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-chains" class="md-nav__link">
    Base Chains
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rules-syntax" class="md-nav__link">
    Rules Syntax
  </a>
  
    <nav class="md-nav" aria-label="Rules Syntax">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#statements-actions" class="md-nav__link">
    Statements (actions)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-actions-for-base-chains" class="md-nav__link">
    Default Actions for Base Chains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expressions-conditions" class="md-nav__link">
    Expressions (conditions)
  </a>
  
    <nav class="md-nav" aria-label="Expressions (conditions)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-connection-state-in-rules" class="md-nav__link">
    Using Connection State in Rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-policies" class="md-nav__link">
    Default Policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-nat-template" class="md-nav__link">
    Final NAT Template
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#editing-nftable-rules-safely" class="md-nav__link">
    Editing nftable Rules Safely
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    Resources
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="introduction-to-netfilter-and-nftables-2022-04-02">Introduction to netfilter and nftables (2022-04-02)<a class="headerlink" href="#introduction-to-netfilter-and-nftables-2022-04-02" title="Permanent link">&para;</a></h1>
<p>This guide introduces nftables by building a basic ruleset that allows us to safely forward packets between internal and external networks while also masquerading traffic with the IP address of the external network interface. <em>Read the entire guide carefully before attempting to install the template or any of the other tools referenced here</em>.</p>
<h2 id="what-is-nftables">What is nftables<a class="headerlink" href="#what-is-nftables" title="Permanent link">&para;</a></h2>
<p><em>nftables</em> is the default tool used to manage netfilter's <em>packet filter rules</em> in Raspberry Pi OS. Though <em>nftables</em> was originally released in 2014, it did not make its way into Raspberry Pi OS until the Bullseye release in November 2021. <em>nftables</em> is the successor to <em>iptables</em>, which has been in use within the Linux community for more than 20 years.</p>
<p><em>nftables</em> is a packet filtering framework that has been adopted across a variety of modern Linux implementations. Packet filtering is a powerful technique that enables administrators to analyze and control the flow of inbound and outbound network traffic from any Linux-based endpoint or intermediate network node. This level of control is essential for host- and network-based firewalls, network address translation (NAT), and other applications.</p>
<p>Packet filters define rules to match traffic based primarily on Layer 2 - 4 properties, including the inbound or outbound interface, type and length of messages, addresses, ports, and connection state. Each filter also describes actions taken when a match is found. Matches may be logged, delivered, or dropped. Administrators may also use packet filters to apply NAT, make decisions about Quality of Service, or to reroute packets mid-flight.</p>
<p><em>nftables</em> builds on <em>netfilter</em>, an open-source project providing hooks, connection tracking, and other capabilities within the Linux network stack. These components enable dynamic filters, like <em>nftables</em> rules, to be applied to every packet traversing the network stack. They are the secret sauce to many of the applications described above. </p>
<h2 id="nftables-configuration">nftables Configuration<a class="headerlink" href="#nftables-configuration" title="Permanent link">&para;</a></h2>
<p>By default, Raspberry Pi OS will load <em>nftables</em> rules from the configuration stored at <em>/etc/nftables.conf</em>. The <em>nft</em> utility allows administrators to create, read, update, and delete elements of the ruleset dynamically at runtime. To view the current ruleset at any time, call <code>nft list ruleset</code>.<sup id="fnref:sudo"><a class="footnote-ref" href="#fn:sudo">1</a></sup> <sup id="fnref:syntax"><a class="footnote-ref" href="#fn:syntax">2</a></sup> </p>
<p>Though <em>nftables</em> provides several options for rule editing, you may encounter negative consequences if you add rules or modify the default configuration haphazardly. Every thing you need to test and verify a simple ruleset is presented in a <a href="#editing-nftable-rules-safely">later section</a>.</p>
<h2 id="tables-chains-and-rule-syntax">Tables, Chains, and Rule Syntax<a class="headerlink" href="#tables-chains-and-rule-syntax" title="Permanent link">&para;</a></h2>
<p>The basic 
!!! info Initial contents of /etc/nftables.conf for Raspberry Pi OS.
    <div class="highlight"><pre><span></span><code>#!/usr/sbin/nft -f

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0;
    }
    chain forward {
        type filter hook forward priority 0;
    }
    chain output {
        type filter hook output priority 0;
    }
}
</code></pre></div></p>
<h3 id="tables">Tables<a class="headerlink" href="#tables" title="Permanent link">&para;</a></h3>
<p><em>nftables</em> uses a basic structure called a table to organize rules. Each table is associated with a single address family and will sets of rules that are applied to packets of that family. </p>
<p>To create rules for layer-3 packets, we will consider the following three address families:</p>
<ul>
<li><code>ip</code>: for IPv4 rules (default)</li>
<li><code>ip6</code>: for IPv6 rules</li>
<li><code>inet</code>: for rules that apply to both IPv4 and IPv6 packets</li>
</ul>
<p>While <em>iptables</em> included a default set of tables for common packet filter functionality, <em>nftables</em> administrators are left to define their own tables. For this exercise, we'll create an IPv4 <code>nat</code> table to implement <em>address translation</em> between private and public addresses and an IPv4/IPv6 <code>filter</code> table to protect the Pi and the rest of our LAN from malicious traffic.<sup id="fnref:table_names"><a class="footnote-ref" href="#fn:table_names">3</a></sup></p>
<h3 id="chains">Chains<a class="headerlink" href="#chains" title="Permanent link">&para;</a></h3>
<p>Within each table, rules are assigned to a structure called a chain. A chain is an ordered list of rules describing the packets to match and the action to take when a match is found. When a chain is processed, the rules in it are tested in order from the beginning until a match is found. If <em>nftables</em> finds a match while evaluating a rule, the remaining rules in that chain are skipped. </p>
<h4 id="base-chains">Base Chains<a class="headerlink" href="#base-chains" title="Permanent link">&para;</a></h4>
<p>Chains are not evaluated arbitrarily in <em>nftables</em>. We can process a chain for a packet by associating it with a <a href="/resources/netfilter-hooks"><em>netfilter hook</em></a>.<sup id="fnref:hooks-reference"><a class="footnote-ref" href="#fn:hooks-reference">4</a></sup> A chain that is associated with a hook is called a <em>base chain</em>.</p>
<p>Within the <code>filter</code> table, we are going to work with three base chains named <code>input</code>, <code>output</code>, and <code>forward</code>. These chains will be associated with <em>filter</em> hooks of the same names,<sup id="fnref:chain_names"><a class="footnote-ref" href="#fn:chain_names">5</a></sup>, and they are processed when packets are being received by Pi (<code>input</code>), when packets are being sent out by software on the Pi (<code>output</code>), or when packets are being routed by the Pi from one network to another (<code>FORWARD</code>). </p>
<div class="admonition filter table and empty base chains">
<p class="admonition-title">Filter</p>
<div class="annotate highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain input {</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook input priority 0;</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0;</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain output {</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook output priority 0;</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <code>nat</code> table will have one base chain that is named for its respective <em>hook</em>, i.e., <code>postrouting</code>. Within netfilter, the postrouting hooks are the last ones to be processed when sending or forwarding a packet. As such, rules processed here can modify the source address for SNAT applications such as masquerading. netfilter also defines a prerouting nat hook that executes before routing decisions and can be used to implement DNAT.</p>
<p>!!! NAT with postrouting base chain`
    <div class="highlight"><pre><span></span><code>table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100;
    }
}
</code></pre></div></p>
<h3 id="rules-syntax">Rules Syntax<a class="headerlink" href="#rules-syntax" title="Permanent link">&para;</a></h3>
<h4 id="statements-actions">Statements (actions)<a class="headerlink" href="#statements-actions" title="Permanent link">&para;</a></h4>
<p>accept (terminal)
drop (terminal)
<a href="https://wiki.nftables.org/wiki-nftables/index.php/Accepting_and_dropping_packets">https://wiki.nftables.org/wiki-nftables/index.php/Accepting_and_dropping_packets</a></p>
<p>counter (non-terminal)
<a href="https://wiki.nftables.org/wiki-nftables/index.php/Counters">https://wiki.nftables.org/wiki-nftables/index.php/Counters</a></p>
<p>masquerade (terminal)</p>
<p>the masquerade keyword replaces a packet's source address with the address of the output interface </p>
<p>In a simple configuration, this option provides the action to be carried out against the packet after the match. While we will encounter the <code>MASQUERADE</code> option in our NAT rules, we will more frequently with basic <code>ACCEPT</code> and <code>DROP</code> rules within the filter context. </p>
<p>In more complex configurations, <code>-j</code> can point to user-defined chains containing additional rules that relate to the pattern you just matched. As you gain experience, you'll see that this provides a greater degree of organization and control flow. </p>
<p>Bringing this option together with the earlier examples, we can express complete rules using the following syntax:</p>
<div class="highlight"><pre><span></span><code>iptables -t nat -A POSTROUTING -o &lt;WAN&gt; -j MASQUERADE
iptables -A FORWARD -i &lt;WAN&gt; -o &lt;LAN&gt; -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</code></pre></div>
<h4 id="default-actions-for-base-chains">Default Actions for Base Chains<a class="headerlink" href="#default-actions-for-base-chains" title="Permanent link">&para;</a></h4>
<h4 id="expressions-conditions">Expressions (conditions)<a class="headerlink" href="#expressions-conditions" title="Permanent link">&para;</a></h4>
<p>Our rules need to describe the criteria associated with packets we want to filter or manipulate. In this exercise, our <em>primary consideration</em> will be the <em>direction</em> in which a given packet is moving.
We can describe this by examining the ingress network for incoming packets and/or the egress network interface for outgoing packets. </p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Throughout the instructions, we'll refer to the internal interface as our <strong>&lt;LAN&gt;</strong> (because it serves our local network) and the external interface as the <strong>&lt;WAN&gt;</strong> (because it connects us to the Internet). Your configuration files will reflect the system assigned interface names, such as: <strong><code>eth0</code></strong> and <strong><code>wlan0</code></strong>.</p>
<p>It's up to you to determine, based on your learning so far, which interface corresponds to which placeholder.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Applying rules to outbound traffic</p>
<p>Let's look at a rule that will apply address translation to outbound packets. Since outbound packets will leave on the <strong>&lt;WAN&gt;</strong>, we can specify this restriction in our <code>postrouting</code> rule with the following expression <code>oifname &lt;WAN&gt;</code>.</p>
<p>In context, this might look like:</p>
<div class="annotate highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">table ip nat {</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain postrouting {</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type nat hook postrouting priority srcnat;</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">oifname &lt;WAN&gt; masquerade</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Similarly, if we wanted to create a rule Likewise, we can instruct iptables to look at packets coming from the <strong>&lt;LAN&gt;</strong> and to the <strong>&lt;WAN&gt;</strong> by combining the <code>-i</code> option with <code>-o</code> in our filter rules.</p>
<div class="admonition example">
<p class="admonition-title">Example: Combining multiple expressions</p>
<p>The following filter rule will allow outbound traffic forwarded from the  <strong>&lt;LAN&gt;</strong> to the <strong>&lt;WAN&gt;</strong>.</p>
<div class="annotate highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0;</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;LAN&gt; oifname &lt;WAN&gt; accept</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
</div>
<h5 id="using-connection-state-in-rules">Using Connection State in Rules<a class="headerlink" href="#using-connection-state-in-rules" title="Permanent link">&para;</a></h5>
<p>Netfilter is a <em>stateful</em> filtering framework, meaning that it is even possible to specify nftables rules based on the state of a network connection for a given packet. This feature shapes our rules in two ways. </p>
<p>First, you'll notice that we only have to specify the masquerade rule in the outward direction. The same rule also handles the de-masquerading process for incoming packets. </p>
<p>Second, you'll see that we can base filtering decisions on connection state itself. While it's appropriate for NAT routers to allow outgoing traffic, we typically want to place greater restrictions on incoming traffic. When configuring a gateway connection for a home or office, we often block incoming traffic unless it relates to existing connections from the LAN. Unsolicited traffic does not make sense in this context and poses a security risk.</p>
<p>To accomplish this feat, we will make use of netfilter's connection tracking extensions which are specified with the <code>-m conntrack</code> and <code>--ctstate RELATED,ESTABLISHED</code> options.</p>
<div class="admonition attention">
<p class="admonition-title">Copy/Paste Warning</p>
<p>These are examples only. Keep reading to learn how to build complete rules.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Using the connection tracking extension</p>
<p>Check the connection state of ingress traffic.</p>
<p>```</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Combining multiple expressions</p>
<p>The following filter rule will allow outbound traffic forwarded from the  <strong>&lt;LAN&gt;</strong> to the <strong>&lt;WAN&gt;</strong>.</p>
<p><div class="annotate highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">table inet filter {</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">chain forward {</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">type filter hook forward priority 0;</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;LAN&gt; oifname &lt;WAN&gt; accept</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">iifname &lt;WAN&gt; ct state established,related accept</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">}</span><span class="w"></span>
</code></pre></div>
```</p>
</div>
<h3 id="default-policies">Default Policies<a class="headerlink" href="#default-policies" title="Permanent link">&para;</a></h3>
<p>We haven't yet said what will happen if your iptables chains complete without any matching rules. Each iptables chain defines a policy that specifies the default actions that will be taken if no other rule matches in a chain.</p>
<p>Default policies are commonly used with the filter chains to implement a posture of failing securely, blocking traffic that wasn't explicitly allowed.</p>
<div class="highlight"><pre><span></span><code># Don&#39;t forward packets unless there was an explicit rule match
iptables -P FORWARD DROP  
</code></pre></div>
<p>Be careful, however, that you don't lock yourself out by a bad combination of rules and policies. For example, setting <code>-P INPUT DROP</code> and <code>-P OUTPUT DROP</code> will block all inbound and outbound traffic to your Pi unless you previously added rules to explicitly allow SSH or other tools that are needed for management purposes. Even when you correctly add these rules, it's relatively easy to lock yourself out of a device by flushing your current ruleset --  deleting the rules from all chains while leaving your policies intact.</p>
<h3 id="final-nat-template">Final NAT Template<a class="headerlink" href="#final-nat-template" title="Permanent link">&para;</a></h3>
<p>The following template draws together all of the components we have discussed so far to define a basic NAT configuration for a Linux router. The syntax for this template differs somewhat from the commands we explored above. Rather than invoking each rule or policy in this file through the <code>iptables</code> command, this template would be applied via <code>iptables-restore</code> or <code>iptables-apply</code>. </p>
<p>To prepare to use this template, save a copy of this template to the home directory (file name does not matter) of your Linux router. Pay close attention to the comments within the file, since they explain some of the differences in syntax.</p>
<div class="highlight"><pre><span></span><code># Fill in the parameters in &lt;&gt; in order to complete the ruleset

# Rules are given on a table-by-table basis, beginning with the *&lt;table&gt; and
# ending with COMMIT.

# Rules are appended to a chain using the -A &lt;chain&gt; syntax. Parameters vary
# somewhat by chain and type of effect desired.

# The -j switch instructs the rules engine to jump to another chain or perform
# the action on the matched packet. The engine will not evaluate any more rules
# in the given chain.

# The default policy for a chain is given by the lines beginning with
# :&lt;chain&gt;. The [0:0] resets the packet/byte counters that tell us how many
# times the default policy has been applied. Note that default policy is
# evaluated after all rules, so it only applies if there were not any matches.

*nat
-A POSTROUTING -o &lt;interface&gt; -j MASQUERADE
COMMIT

*filter
:FORWARD &lt;action&gt; [0:0]
-A FORWARD -i &lt;interface&gt; -o &lt;interface&gt; -j ACCEPT
-A FORWARD -i &lt;interface&gt; -o &lt;interface&gt; -m conntrack --ctstate RELATED,ESTABLISHED -j &lt;action&gt;
COMMIT
</code></pre></div>
<h2 id="editing-nftable-rules-safely">Editing nftable Rules Safely<a class="headerlink" href="#editing-nftable-rules-safely" title="Permanent link">&para;</a></h2>
<p>At boot, Raspberry Pi OS loads the current packet filter state from <code>/etc/nftables.conf</code>. Changes must be added to this file if you want them to persist through a reboot; however, we don't recommend editing it directly. Follow along below for a safer alternative.</p>
<div class="admonition danger">
<p class="admonition-title">Here be Dragons</p>
<p>Do not write rules directly to <code>/etc/nftables.conf</code>. If you do this, you risk creating a rule that locks you out of your device from the network. Without an external monitor and keyboard, you will not be able to bypass these changes since they are loaded at boot. </p>
</div>
<p>Create a working copy of <code>/etc/nftables.conf</code> into your <em>home directory</em> <em>(it is okay to rename the file)</em>. Open the new copy and ensure that <code>flush ruleset</code> near the top (before your table definitions).<sup id="fnref:flush"><a class="footnote-ref" href="#fn:flush">6</a></sup> Proceed with any modifications to the working copy.</p>
<p>To test your ruleset, we recommend a scripted approach that can automatically revert a change that locks you out of the Pi. INFO314 students can find a copy of <code>nftables-apply.sh</code> in the project repository or create the script from the following listing.</p>
<details class="info">
<summary>nftables-apply.sh</summary>
<div class="highlight"><pre><span></span><code>#!/bin/bash

# Adapted from https://sanjuroe.dev/nft-safe-reload (retrieved on 2022-04-03)
# Modified to avoid editing system rules in-place

SYSTEM_RULES=&quot;/etc/nftables.conf&quot;
TIMEOUT=45

saved_rules=$(mktemp)
cleanup() {
    rm -f &quot;$saved_rules&quot;
}

trap &quot;cleanup&quot; EXIT;

# Waits $TIMEOUT seconds for a yes/no response
read_approval() {
        read -t $TIMEOUT response 2&gt; /dev/null

        case &quot;$response&quot; in
                y|Y)
                        return 0
                        ;;
                *)
                        return 1
                        ;;
        esac
}

# Make a copy of the active ruleset
backup() {
        printf &quot;flush ruleset\n&quot; &gt; $saved_rules
        nft list ruleset &gt;&gt; $saved_rules
}

# Apply a named ruleset
apply() {
        nft -f &quot;$1&quot;
}

# Update system ruleset
save() {
    local source_rules=&quot;$1&quot;
    cp --no-preserve=mode,ownership &quot;$source_rules&quot; &quot;$SYSTEM_RULES&quot;
}

# Make a backup of the active ruleset in case of rollback
backup
new_rules=&quot;$1&quot;

if apply &quot;$new_rules&quot;; then
    printf &quot;Are you still able to connect to your device (auto-rollback in $TIMEOUT seconds)? [y/n] &quot;
        if read_approval; then
        save &quot;$new_rules&quot;
                printf &quot;\nUpdated system ruleset at ${SYSTEM_RULES}\n&quot;
        exit 0
        else
                apply &quot;$saved_rules&quot;
        printf &quot;\nRolling back to original configuration\n&quot;
                exit 2
        fi
fi
</code></pre></div>
</details>
<p>To test your rules, pass the name of your new rules file to the <em>nftables-apply.sh</em> script, e.g., <code>./nftables-apply.sh nftables-test.conf</code>. If your rules load without any errors, you will be prompted to answer whether you can still connect. </p>
<p>Open an <strong>additional</strong> terminal window and launch to connect to your Pi. If you are able to complete this step successfully, you can apply your changes to <code>/etc/nftables.conf</code> by answering <strong>y</strong> at the <em>nftables-apply.sh</em> prompt in your original session. </p>
<p><img alt="Accept New Rules" src="/img/accept-nft-rules.png" /></p>
<p>If the test fails, answer <strong>n</strong> or wait 45 seconds for the rules to revert automatically.</p>
<p><img alt="Reject New Rules" src="/img/rollback-nft-rules.png" /></p>
<p>Once you are satisified that your rules are working correctly, it's a good idea to verify that everything works correctly after a reboot. Reboot now and use the <code>nft list ruleset</code> command to view active rules.</p>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="/resources/netfilter-hooks">Understanding Netfilter Hooks</a></li>
<li><a href="https://www.datapacket.com/blog/securing-your-server-with-nftables">Securing Your Server with nftables</a></li>
<li><a href="https://sanjuroe.dev/nft-safe-reload">Safe Reload with nftables</a></li>
<li><a href="https://www.oreilly.com/openbook/linag2/book/ch11.html">Linux Network Administrators Guide - Masquerading</a></li>
</ul>
<p>sysemctl enable nftables</p>
<p>NAT specific actions
snat
dnat
redirect</p>
<p>Other
reject
log
jump to a regular chain before returning to this chain
goto a regular chain without returning
return</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:sudo">
<p>Root privileges are required to view or edit the nftables ruleset. Don't forget to <em>sudo</em> as required.&#160;<a class="footnote-backref" href="#fnref:sudo" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:syntax">
<p>For simplicity, this guide will focus on the table-based format seen when using the <em>nft list</em> command.&#160;<a class="footnote-backref" href="#fnref:syntax" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:table_names">
<p>These names are chosen to mirror the built-in tables of <em>iptables</em>.&#160;<a class="footnote-backref" href="#fnref:table_names" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:hooks-reference">
<p>Further information about hooks is provided in the default&#160;<a class="footnote-backref" href="#fnref:hooks-reference" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:chain_names">
<p>Once again, this naming convention is influenced by <em>iptables</em> and its built-in chains.&#160;<a class="footnote-backref" href="#fnref:chain_names" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:flush">
<p><code>nft -f &lt;FILENAME&gt;</code> is additive by default. Including <code>flush ruleset</code> before your table/chain definitions ensures that the new ruleset is properly loaded.&#160;<a class="footnote-backref" href="#fnref:flush" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Clinton Campbell
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.5e67fbfe.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.e87a5f81.min.js"></script>
      
    
  </body>
</html>