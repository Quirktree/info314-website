<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Clinton Campbell">
        <link rel="canonical" href="https://info314.tcpip.dev/resources/iptables/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Introduction to iptables - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/color-brewer.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/pi-setup/" class="dropdown-item">Raspberry Pi Setup</a>
</li>
            
<li>
    <a href="../wifi-reference/" class="dropdown-item">Wireless Configuration Reference</a>
</li>
            
<li>
    <a href="../uw-wireless/" class="dropdown-item">UW Wireless Reference</a>
</li>
            
<li>
    <a href="../../assignments/networkd-setup/" class="dropdown-item">networkd Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../address-planning/" class="dropdown-item">IP Address Planning Reference</a>
</li>
            
<li>
    <a href="../../assignments/dhcp-setup/" class="dropdown-item">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/router-setup/" class="dropdown-item">Router Setup</a>
</li>
            
<li>
    <a href="../nftables/" class="dropdown-item">Introduction to nftables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/resolver-setup/" class="dropdown-item">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Report - NAT and DNS Analysis</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/analysis-report/" class="dropdown-item">Instructions</a>
</li>
            
<li>
    <a href="../tshark-install/" class="dropdown-item">Installing TShark</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">5 - Configure an Authoritative Name Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../assignments/dns-zone-setup/" class="dropdown-item">Authoritative Zone Setup</a>
</li>
            
<li>
    <a href="../zone-file-format/" class="dropdown-item">DNS Zone Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Extra Credit</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="/" class="dropdown-item">VLAN Challenge</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../assignments/wireshark01/" class="dropdown-item">Lab 1 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li>
    <a href="../../assignments/wireshark02/" class="dropdown-item">Lab 2 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li>
    <a href="../../assignments/wireshark03/" class="dropdown-item">Lab 3 - Analyze Zeroconf in Wireshark</a>
</li>
                                    
<li>
    <a href="../../assignments/wireshark04/" class="dropdown-item">Lab 4 - Analyze TCP with ncat and Wireshark</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Getting Started</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../markdown/" class="dropdown-item">Intro to Markdown</a>
</li>
            
<li>
    <a href="../bash/" class="dropdown-item">Intro to Bash</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../address-planning/" class="dropdown-item">Basic IP Address Planning</a>
</li>
            
<li>
    <a href="../../notes/dns-overview/" class="dropdown-item">Domain Name System (DNS)</a>
</li>
            
<li>
    <a href="../zone-file-format/" class="dropdown-item">DNS Zone Files</a>
</li>
            
<li>
    <a href="../../notes/ethernet-switches/" class="dropdown-item">Ethernet Switches</a>
</li>
            
<li>
    <a href="../../notes/router-overview/" class="dropdown-item">Routers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Core Settings and Tools</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ssh-primer/" class="dropdown-item">Getting Started with SSH</a>
</li>
            
<li>
    <a href="../ssh-agent/" class="dropdown-item">Using the SSH Agent</a>
</li>
            
<li>
    <a href="../wireshark-install/" class="dropdown-item">Install Wireshark</a>
</li>
            
<li>
    <a href="../tshark-install/" class="dropdown-item">Install TShark</a>
</li>
            
<li>
    <a href="../host-config/" class="dropdown-item">Mac/Win/Linux Networking</a>
</li>
            
<li>
    <a href="../manage-dhcp/" class="dropdown-item">Troubleshooting DHCP</a>
</li>
            
<li>
    <a href="../dns-clients/" class="dropdown-item">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">General Linux Networking</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Firewalls</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../nftables/" class="dropdown-item">Introduction to nftables</a>
</li>
            
<li>
    <a href="../netfilter-hooks/" class="dropdown-item">Understanding netfilter Hooks</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Introduction to iptables</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Network Interfaces</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../loopback-interfaces/" class="dropdown-item">Loopback Interfaces</a>
</li>
            
<li>
    <a href="../dummy-interfaces/" class="dropdown-item">Dummy Interfaces</a>
</li>
            
<li>
    <a href="../vlan-interfaces/" class="dropdown-item">VLAN Interfaces</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Virtual Private Networking</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../setup-wireguard/" class="dropdown-item">Install and Configure WireGuard</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Wireless</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../wifi-reference/" class="dropdown-item">wpa_supplicant Reference</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Free Range Routing</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../setup-frr/" class="dropdown-item">Install Free Range Routing (FRR)</a>
</li>
            
<li>
    <a href="../configure-routing-links/" class="dropdown-item">Configuring Routing Links</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">University of Washington Networks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../uw-wireless/" class="dropdown-item">UW Wireless Network Reference</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../netfilter-hooks/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../loopback-interfaces/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/quirktree/info314-website" class="nav-link">quirktree/info314-website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#introduction-to-iptables-2022-04-02" class="nav-link">Introduction to Iptables (2022-04-02)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#tables-chains-and-rule-syntax" class="nav-link">Tables, Chains, and Rule Syntax</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#loading-rules-from-the-file-system-with-iptables-persistent" class="nav-link">Loading rules from the file system with iptables-persistent</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#resources" class="nav-link">Resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="introduction-to-iptables-2022-04-02">Introduction to Iptables (2022-04-02)<a class="headerlink" href="#introduction-to-iptables-2022-04-02" title="Permanent link">&para;</a></h1>
<p>This guide serves the dual purpose of introducing iptables and using it to build a basic ruleset that routes packets between an internal and external network while also applying NAT to private, internal addresses. You should read the entire guide carefully before attempting to install the template or any of the other tools referenced here.</p>
<h2 id="tables-chains-and-rule-syntax">Tables, Chains, and Rule Syntax<a class="headerlink" href="#tables-chains-and-rule-syntax" title="Permanent link">&para;</a></h2>
<p>Iptables is a tool that has been used for more than 20 years to allow administrators to manage <em>packet filter rules</em> that shape the behavior of the Linux kernel's network stack.</p>
<h3 id="tables">Tables<a class="headerlink" href="#tables" title="Permanent link">&para;</a></h3>
<p>Iptables uses a basic structure called a table to group rules according to their main function. Common tables include <code>nat</code>, <code>filter</code>, <code>mangle</code>, and <code>raw</code>. For this exercise, we'll focus on the <code>nat</code> table to implement <em>address translation</em> between private and public addresses along with the <code>filter</code> table to protect our network from outside traffic. </p>
<h3 id="chains">Chains<a class="headerlink" href="#chains" title="Permanent link">&para;</a></h3>
<p>Within each table, rules are assigned to a structure called a chain. A chain is nothing more than an ordered list of rules. Rule conditions are tested in order from the beginning of the chain. Each rule ends with an action. If the conditions of a rule match, iptables will apply the specified action or jump to another chain without processing the other rules. If conditions do not match, the next rule in the chain will be evaluated.</p>
<p>The default chains correspond to different points in the packet lifecycle. Within the <code>filter</code> table, we will often work with the <code>INPUT</code>, <code>OUTPUT</code>, and <code>FORWARD</code> chains. These chains correspond to packets sent to the host (<code>INPUT</code>), packets being sent by the host (<code>OUTPUT</code>), and packets being routed through the host (<code>FORWARD</code>). </p>
<p>Within the <code>nat</code> table, our focus will be on the <code>POSTROUTING</code> chain. This chain represents the last set of rules that will be evaluated before forwarding a filtered packet. This is where we want to apply address mappings related to SNAT and masquerading. In contrast, the <code>PREROUTING</code> chain is applied before any other process and is used to specify DNAT rules.</p>
<p>For a more detailed exploration of the chains we have discussed, see <a href="/resources/netfilter-hooks">Understanding Netfilter/Iptables Hooks</a>.</p>
<h3 id="managing-rules-from-the-command-line">Managing Rules from the Command Line<a class="headerlink" href="#managing-rules-from-the-command-line" title="Permanent link">&para;</a></h3>
<p>We can load a set of iptables rules from a file or manage them directly from the command line with the <code>iptables</code> command (<code>sudo</code> is required). As we explain the structure of rules, we will provide examples using the command line variant of iptables rule syntax.</p>
<p>The first component of a rule specified from the command line is the table name. Specify the table using the <code>-t</code> option to the <code>iptables command</code>. If you don't specify a table explicitly, the filter table will be used by default. </p>
<p>When working with rules via the command line, we have to work with rules one at a time and specify the order of operations as we go. Recall from the last section that the order of rules in a chain is significant. We can append new rules to the end of a chain using the <code>-A</code> option or insert rules at the beginning of a chain using <code>-I</code>. Likewise, we can delete a rule from a chain by specifying <code>-D</code> and providing a numeric index to the rule.</p>
<details class="attention">
<summary>Copy/Paste Warning</summary>
<p>These are examples only. Keep reading to learn how to build complete rules.</p>
</details>
<div class="admonition example">
<p class="admonition-title">Example: Appending Rules</p>
<p>Append a rule to the end of the POSTROUTING chain of the nat table ...</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>iptables -t nat -A POSTROUTING &lt;conditions&gt; &lt;actions&gt;
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Deleting Rules</p>
<p>Delete the first rule from the FORWARD chain of filter</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>iptables -D FORWARD 1           
</code></pre></div>
</div>
<h3 id="customize-rules-with-filter-conditions">Customize Rules with Filter Conditions<a class="headerlink" href="#customize-rules-with-filter-conditions" title="Permanent link">&para;</a></h3>
<p>In addition to specifying table and chain, our rules need to describe the criteria associated with packets we want to filter or manipulate. In this exercise, our <em>primary consideration</em> is the <em>direction of traffic</em> for a given packet, which we describe by specifying the ingress and/or egress interface for a given packet. </p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Throughout the instructions, we'll refer to the internal interface as our <strong>&lt;LAN&gt;</strong> (because it serves our local network) and the external interface as the <strong>&lt;WAN&gt;</strong> (because it connects us to the Internet). Your configuration files will reflect the system assigned interface names, such as: <strong><code>eth0</code></strong> and <strong><code>wlan0</code></strong>.</p>
<p>It's up to you to determine, based on your learning so far, which interface corresponds to which placeholder.</p>
</div>
<p>For example, we want to apply address translation to outbound packets, i.e., packets being forwarded in the <strong>&lt;LAN&gt;</strong> interface and out the <strong>&lt;WAN&gt;</strong> interface. We can specify this restriction in our <code>nat</code> rule by providing the <code>-o</code> option with the name of the outbound interface. Likewise, we can instruct iptables to look at packets coming from the <strong>&lt;LAN&gt;</strong> and to the <strong>&lt;WAN&gt;</strong> by combining the <code>-i</code> option with <code>-o</code> in our filter rules.</p>
<details class="attention">
<summary>Copy/Paste Warning</summary>
<p>These are examples only. Keep reading to learn how to build complete rules.</p>
</details>
<div class="admonition example">
<p class="admonition-title">Example: Adding filter conditions to rules</p>
<p>This NAT rule will be applied on outbound traffic that's being routed to the WAN network.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>iptables -t NAT -A POSTROUTING -o &lt;WAN&gt; &lt;actions&gt;
</code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Combining multiple filters</p>
<p>The following filter rule will be applied to outbound traffic that's being forwarded from the LAN to the WAN.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>iptables -A FORWARD -i &lt;LAN&gt; -o &lt;WAN&gt; &lt;actions&gt;
</code></pre></div>
</div>
<h3 id="using-connection-state-in-rules">Using Connection State in Rules<a class="headerlink" href="#using-connection-state-in-rules" title="Permanent link">&para;</a></h3>
<p>Iptables is <em>stateful</em>, meaning that it is even possible to specify rules based on the relationship of a packet to other packets that were processed by iptables. This feature shapes our rules in two ways. </p>
<p>First, you'll notice that we only have to specify the masquerade rule in the outward direction. The same rule also handles the de-masquerading process for incoming packets. </p>
<p>Second, you'll see that we can base filtering decisions on connection state itself. While it's appropriate for NAT routers to allow outgoing traffic, we typically want to place greater restrictions on incoming traffic. When configuring a gateway connection for a home or office, we often block incoming traffic unless it relates to existing connections from the LAN. Unsolicited traffic does not make sense in this context and poses a security risk.</p>
<p>To accomplish this feat, we will make use of netfilter's connection tracking extensions which are specified with the <code>-m conntrack</code> and <code>--ctstate RELATED,ESTABLISHED</code> options.</p>
<div class="admonition attention">
<p class="admonition-title">Copy/Paste Warning</p>
<p>These are examples only. Keep reading to learn how to build complete rules.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example: Using the connection tracking extension</p>
<p>Check the connection state of ingress traffic.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>iptables -A FORWARD -i &lt;WAN&gt; -m conntrack --ctstate RELATED,ESTABLISHED &lt;action&gt;
</code></pre></div>
</div>
<h3 id="specify-an-action">Specify an Action<a class="headerlink" href="#specify-an-action" title="Permanent link">&para;</a></h3>
<p>The last component of an iptables rule is specified using the <code>-j</code> option. In a simple configuration, this option provides the action to be carried out against the packet after the match. While we will encounter the <code>MASQUERADE</code> option in our NAT rules, we will more frequently with basic <code>ACCEPT</code> and <code>DROP</code> rules within the filter context. </p>
<p>In more complex configurations, <code>-j</code> can point to user-defined chains containing additional rules that relate to the pattern you just matched. As you gain experience, you'll see that this provides a greater degree of organization and control flow. </p>
<p>Bringing this option together with the earlier examples, we can express complete rules using the following syntax:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>iptables -t nat -A POSTROUTING -o &lt;WAN&gt; -j MASQUERADE
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>iptables -A FORWARD -i &lt;WAN&gt; -o &lt;LAN&gt; -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</code></pre></div>
<h3 id="default-actions">Default Actions<a class="headerlink" href="#default-actions" title="Permanent link">&para;</a></h3>
<p>We haven't yet said what will happen if your iptables chains complete without any matching rules. Each iptables chain defines a policy that specifies the default actions that will be taken if no other rule matches in a chain.</p>
<p>Default policies are commonly used with the filter chains to implement a posture of failing securely, blocking traffic that wasn't explicitly allowed.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a># Don&#39;t forward packets unless there was an explicit rule match
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>iptables -P FORWARD DROP  
</code></pre></div>
<p>Be careful, however, that you don't lock yourself out by a bad combination of rules and policies. For example, setting <code>-P INPUT DROP</code> and <code>-P OUTPUT DROP</code> will block all inbound and outbound traffic to your Pi unless you previously added rules to explicitly allow SSH or other tools that are needed for management purposes. Even when you correctly add these rules, it's relatively easy to lock yourself out of a device by flushing your current ruleset --  deleting the rules from all chains while leaving your policies intact.</p>
<h3 id="final-nat-template">Final NAT Template<a class="headerlink" href="#final-nat-template" title="Permanent link">&para;</a></h3>
<p>The following template draws together all of the components we have discussed so far to define a basic NAT configuration for a Linux router. The syntax for this template differs somewhat from the commands we explored above. Rather than invoking each rule or policy in this file through the <code>iptables</code> command, this template would be applied via <code>iptables-restore</code> or <code>iptables-apply</code>. </p>
<p>To prepare to use this template, save a copy of this template to the home directory (file name does not matter) of your Linux router. Pay close attention to the comments within the file, since they explain some of the differences in syntax.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a># Fill in the parameters in &lt;&gt; in order to complete the ruleset
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a># Rules are given on a table-by-table basis, beginning with the *&lt;table&gt; and
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a># ending with COMMIT.
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a># Rules are appended to a chain using the -A &lt;chain&gt; syntax. Parameters vary
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a># somewhat by chain and type of effect desired.
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a># The -j switch instructs the rules engine to jump to another chain or perform
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a># the action on the matched packet. The engine will not evaluate any more rules
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a># in the given chain.
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a># The default policy for a chain is given by the lines beginning with
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a># :&lt;chain&gt;. The [0:0] resets the packet/byte counters that tell us how many
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a># times the default policy has been applied. Note that default policy is
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a># evaluated after all rules, so it only applies if there were not any matches.
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>*nat
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>-A POSTROUTING -o &lt;interface&gt; -j MASQUERADE
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>COMMIT
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>*filter
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>:FORWARD &lt;action&gt; [0:0]
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>-A FORWARD -i &lt;interface&gt; -o &lt;interface&gt; -j ACCEPT
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>-A FORWARD -i &lt;interface&gt; -o &lt;interface&gt; -m conntrack --ctstate RELATED,ESTABLISHED -j &lt;action&gt;
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>COMMIT
</code></pre></div>
<h2 id="loading-rules-from-the-file-system-with-iptables-persistent">Loading rules from the file system with <code>iptables-persistent</code><a class="headerlink" href="#loading-rules-from-the-file-system-with-iptables-persistent" title="Permanent link">&para;</a></h2>
<p>For simplicity, we’ll rely on on a collection of tools called <code>iptables-persistent</code> to test our rules and then load them automatically at boot. </p>
<div class="admonition danger">
<p class="admonition-title">Here be Dragons</p>
<p>Do not write rules directly to <code>/etc/iptables/rules.v4</code>. If you do this, you risk creating a rule that locks you out of your device from the network. Without an external monitor and keyboard, you will not be able to bypass these changes since they are loaded at boot. </p>
<p>We are presenting <code>iptables-persistent</code> to provide you with a tool that allows us you to apply new rules safely by testing changes before making them fully persistent.</p>
</div>
<p>Like many other tools, <code>iptables-persistent</code> is available as a package in Debian's package repository. This package contains tools to help you test new rules and install them into the <code>/etc/iptables/rules.v4</code> path so that they can be loaded automatically in the future. Use <code>apt</code> to install the <code>iptables-persistent</code> package before attempting the instructions below.</p>
<p>Make a copy of your rules within your <em>home directory</em> (file name does not matter) and use the <code>iptables-apply</code> command as shown below to test that they work before writing them to <code>/etc/iptables/rules.v4</code>. While it is possible to edit <code>/etc/iptables/rules.v4</code> directly, we recomend against it. </p>
<p>The following command will flush iptables and load the rules given in <code>~/untested_rules</code>. After loading the rules, <code>iptables-apply</code> waits for <strong>60 seconds</strong> while you confirm that you can still SSH into the device from a second terminal tab or window. If your rules work as intended, you need respond affirmatively at this final prompt within the time limit so that iptables-apply can write them to a permanent location. If you skip this step, iptables-apply will assume that your test failed and restore the old version of the rules.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>sudo iptables-apply -t 60 -w /etc/iptables/rules.v4 ~/untested_rules
</code></pre></div>
<p>After running the  command, you’ll have one minute to check that everything is working and confirm that you’re ready to apply the rules. If everything checks out, the rules will be written to <code>/etc/iptables/rules.v4</code> (where <code>iptables-persistent</code> can load them at boot). If your connection is interrupted or you decide not to keep the rules, the rules will be reset when the timer expires so that you con continue to access your Pi.</p>
<p>As a final test that your rules are loaded, reboot the Pi, connect with SSH, and list the rules with <code>sudo iptables-save</code>. If you don’t see your rules, something went wrong.</p>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="/resources/netfilter-hooks">Understanding Netfilter/Iptables Hooks</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture">Digital Ocean Tutorial - Iptables and Netfilter Deep Dive</a></li>
<li><a href="http://www.oreilly.com/openbook/linag2/book/ch11.html">Linux Network Administrators Guide - Masquerading</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules">DigitalOcean Tutorial - Manipulate Iptables Rules</a></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2022 Clinton Campbell</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
