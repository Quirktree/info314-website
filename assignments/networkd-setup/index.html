<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Clinton Campbell">
        <link rel="canonical" href="https://info314.tcpip.dev/assignments/networkd-setup/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>networkd Setup - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/color-brewer.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../pi-setup/" class="dropdown-item">Raspberry Pi Setup</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">networkd Setup</a>
</li>
            
<li>
    <a href="../../resources/wifi-reference/" class="dropdown-item">Wireless Configuration Reference</a>
</li>
            
<li>
    <a href="../../resources/uw-wireless/" class="dropdown-item">UW Wireless Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/address-planning/" class="dropdown-item">IP Address Planning Reference</a>
</li>
            
<li>
    <a href="../dhcp-setup/" class="dropdown-item">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../router-setup/" class="dropdown-item">Router Setup</a>
</li>
            
<li>
    <a href="../../resources/nftables/" class="dropdown-item">Introduction to nftables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../resolver-setup/" class="dropdown-item">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Report - NAT and DNS Analysis</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../analysis-report/" class="dropdown-item">Instructions</a>
</li>
            
<li>
    <a href="../../resources/tshark-install/" class="dropdown-item">Installing TShark</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">5 - Configure an Authoritative Name Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../dns-zone-setup/" class="dropdown-item">Authoritative Zone Setup</a>
</li>
            
<li>
    <a href="../../resources/zone-file-format/" class="dropdown-item">DNS Zone Reference</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../wireshark01/" class="dropdown-item">Lab 1 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li>
    <a href="../wireshark02/" class="dropdown-item">Lab 2 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li>
    <a href="../wireshark03/" class="dropdown-item">Lab 3 - Analyze Zeroconf in Wireshark</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Getting Started</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/markdown/" class="dropdown-item">Intro to Markdown</a>
</li>
            
<li>
    <a href="../../resources/bash/" class="dropdown-item">Intro to Bash</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../notes/dns-overview/" class="dropdown-item">Domain Name System (DNS)</a>
</li>
            
<li>
    <a href="../../notes/router-overview/" class="dropdown-item">Routers</a>
</li>
            
<li>
    <a href="../../notes/ethernet-switches/" class="dropdown-item">Ethernet Switches</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Guides</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Common Tools</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/ssh-primer/" class="dropdown-item">Getting Started with SSH</a>
</li>
            
<li>
    <a href="../../resources/ssh-agent/" class="dropdown-item">Using ssh-agent</a>
</li>
            
<li>
    <a href="../../resources/wireshark-install/" class="dropdown-item">Install Wireshark</a>
</li>
            
<li>
    <a href="../../resources/tshark-install/" class="dropdown-item">Install TShark</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">DNS</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/zone-file-format/" class="dropdown-item">Zone File Reference</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Wireless</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/wifi-reference/" class="dropdown-item">Linux Wireless Configuration</a>
</li>
            
<li>
    <a href="../../resources/uw-wireless/" class="dropdown-item">UW Wireless Network Reference</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Iptables</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/iptables/" class="dropdown-item">Introduction to Iptables</a>
</li>
            
<li>
    <a href="../../resources/netfilter-hooks/" class="dropdown-item">Understanding Netfilter/Iptables Hooks</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Planning</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/address-planning/" class="dropdown-item">Basic IP Address Planning</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Routing and VPNs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/setup-frr/" class="dropdown-item">Install Free Range Routing (FRR)</a>
</li>
            
<li>
    <a href="../../resources/setup-wireguard/" class="dropdown-item">Install and Configure WireGuard</a>
</li>
            
<li>
    <a href="../../resources/configure-routing-links/" class="dropdown-item">Configuring Routing Links</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Special Network Interfaces</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/loopback-interfaces/" class="dropdown-item">Loopback Interfaces</a>
</li>
            
<li>
    <a href="../../resources/dummy-interfaces/" class="dropdown-item">Dummy Interfaces</a>
</li>
            
<li>
    <a href="../../resources/vlan-interfaces/" class="dropdown-item">VLAN Interfaces</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">General</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/host-config/" class="dropdown-item">Mac/Win/Linux Networking</a>
</li>
            
<li>
    <a href="../../resources/manage-dhcp/" class="dropdown-item">Troubleshooting DHCP</a>
</li>
            
<li>
    <a href="../../resources/dns-clients/" class="dropdown-item">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../contact/" class="nav-link">Contact Us</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../pi-setup/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../resources/wifi-reference/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/quirktree/info314-website" class="nav-link">quirktree/info314-website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#networkd-setup-for-raspberry-pi-os-2020-01-22" class="nav-link">Networkd Setup for Raspberry Pi OS (2020-01-22)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#intro-to-systemd" class="nav-link">Intro to Systemd</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#systemd-vs-default-networking" class="nav-link">Systemd vs Default Networking</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#enabling-networkd" class="nav-link">Enabling Networkd</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#test-your-configuration" class="nav-link">Test Your Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#troubleshooting" class="nav-link">Troubleshooting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="networkd-setup-for-raspberry-pi-os-2020-01-22">Networkd Setup for Raspberry Pi OS (2020-01-22)<a class="headerlink" href="#networkd-setup-for-raspberry-pi-os-2020-01-22" title="Permanent link">&para;</a></h1>
<h2 id="intro-to-systemd">Intro to Systemd<a class="headerlink" href="#intro-to-systemd" title="Permanent link">&para;</a></h2>
<p>An <strong>init provider</strong> is the first process that is launched on a Linux system. It is responsible for loading other essential services, and it ultimately becomes the parent of every other process on the system. Among the differences between different Linux distributions is the choice of init system.</p>
<p><strong>systemd</strong> is the initialization (init) provider most often deployed on recent Linux distributions. On Raspberry Pi OS and other recent Debian-based distros  <strong>systemd</strong> replaces the aging <strong>sysvinit</strong>. We will interact directly with <strong>systemd</strong> in this tutorial by issuing <strong><code>systemctl</code></strong> commands to start, stop, enable and disable various system-level services.</p>
<p>Beyond its job of launching essential services, <strong>systemd</strong> provides a modular interface to control many parts of the system. We've already interacted with a few of these components when we used <strong><code>localectl</code></strong>, <strong><code>timedatectl</code></strong>, and <strong><code>hostnamectl</code></strong> during the initial setup of the RaspberryPi.</p>
<p>In this tutorial we will leverage three more <strong>systemd</strong> subsystems:</p>
<ul>
<li><strong><code>journald</code></strong> - Collects and catalogs log files from system services and applications. You can explore these files with <strong><code>journalctl</code></strong> as seen in <a href="#troubleshooting">Troubleshooting</a>.</li>
<li><strong><code>networkd</code></strong> - Detects and configures network devices and performs various other network management functions.</li>
<li><strong><code>resolved</code></strong> - Provides network name resolution and maintains a list of DNS servers (network-based resolvers) to contact based on settings provided by DHCP or <strong><code>networkd</code></strong> configuration files.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Attention: Risk of <em>bricking</em> your Pi</p>
<p>A typo or other mistake within the core network configuration can result in total loss of network connectivity, which is required to manage the Pi over ssh.</p>
<p>Before you begin to follow these instructions, make an external copy of critical configs such as <strong>wpa_supplicant</strong> using <strong><code>scp</code></strong> in case it becomes necessary to rebuild. </p>
<p>If you get locked out during this process, please contact the instructor to determine whether it's possible to reconnect without re-imaging the Pi.</p>
</div>
<h2 id="systemd-vs-default-networking">Systemd vs Default Networking<a class="headerlink" href="#systemd-vs-default-networking" title="Permanent link">&para;</a></h2>
<p>By default, Raspberry Pi OS networking relies on a component called dhcpcd to manage interface settings, addresses, etc. While this component works well for general purpose computing, but it is not a match for every scenario.</p>
<p>The current version of Debian (the base OS for Raspberry Pi OS) supports <strong>systemd</strong> based network management via the <strong>systemd-networkd</strong> service. Unlike <strong>dhcpcd</strong>, <strong>networkd</strong> is well-suited to managing the base configuration for our router.</p>
<h2 id="enabling-networkd">Enabling Networkd<a class="headerlink" href="#enabling-networkd" title="Permanent link">&para;</a></h2>
<p>We will enable <strong>networkd</strong> in several steps. Try to complete this process in one sitting to avoid "bricking" your Pi (at least making it inaccessible over the network).</p>
<h3 id="configure-network-interfaces">Configure network interfaces<a class="headerlink" href="#configure-network-interfaces" title="Permanent link">&para;</a></h3>
<p>To configure the network with <strong>networkd</strong>, we create files in <strong><code>/etc/systemd/network/</code></strong> that match named network interfaces and define our desired settings settings. Create the following <strong><code>.network</code></strong> files to handle the default settings for wired and wireless interfaces. Enabling link local addresses is a critical component of these default configurations so that you can still communicate with the Pi when DHCP is not available.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Networkd</strong> configuration is generally easy to work with, but there are a couple of footguns to be aware of:</p>
<ul>
<li>The files are case sensitive and sometimes sensitive to seemingly innocuous changes in spacing. </li>
<li>A file with a missing or invalid [Match] statement will be applied to every interface that hasn't already been matched by an earlier configuration.</li>
</ul>
</div>
<div class="admonition faq">
<p class="admonition-title">FAQ: <strong>Networkd</strong> configuration files</p>
<p><strong><code>man systemd.network</code></strong> provides a comprehensive reference to the format of the <strong>networkd</strong> configuration files and the process for loading them. </p>
<p>At runtime, <strong>networkd</strong> gathers files using the <strong><code>.network</code></strong> extension from several locations, including <strong><code>/etc/systemd/network/</code></strong>. To determine the order in which to apply configuration, <strong>networkd</strong> sorts all of these files lexically. </p>
<p>To maintain proper control over execution order, we can prepend a two digit numeric value to the filename. This allows us to set up high-numbered default configurations that are overriden on a case-by-case basis by low-numberd configs files.</p>
</div>
<h4 id="default-ethernet-configuration"><strong>Default ethernet configuration</strong><a class="headerlink" href="#default-ethernet-configuration" title="Permanent link">&para;</a></h4>
<p><strong><code>/etc/systemd/network/99-eth.network</code></strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>[Match]
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a># Applies to eth0, eth1, ...
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Name=eth*
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>[Network]
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a># Configure IPv4 using DHCP
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>DHCP=ipv4
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a># Enable link local addresses for IPv4 (169.254.x.y) and IPv6 (FE80::)
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>LinkLocalAddressing=yes
</code></pre></div></p>
<h4 id="default-wireless-configuration"><strong>Default wireless configuration</strong><a class="headerlink" href="#default-wireless-configuration" title="Permanent link">&para;</a></h4>
<p><strong><code>/etc/systemd/network/99-wlan.network</code></strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>[Match]
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Name=wlan*
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>[Network]
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>DHCP=ipv4
</code></pre></div></p>
<h3 id="disable-default-networking">Disable default networking<a class="headerlink" href="#disable-default-networking" title="Permanent link">&para;</a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip: Backup configuration before proceeding<p>If you've made any mistakes, you may lose access to your Pi after performing the following steps. </p>
<p>Make an offline backup <strong>before</strong> you proceed by copying files to your local system with <strong><code>scp</code></strong>.</p>
</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a># Disable default Raspberry Pi OS networking
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>sudo systemctl mask dhcpcd.service
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a># Disable legacy Debian networking
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>sudo systemctl mask networking.service
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a># Disable resolvconf service, which manages DNS servers for the OS
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>sudo nano /etc/resolvconf.conf
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a># Add the line resolvconf=NO to the beginning of the file
</code></pre></div>
<h3 id="enable-systemd-network-services">Enable systemd network services<a class="headerlink" href="#enable-systemd-network-services" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a># Enable systemd-networkd to replace Raspberry Pi OS and Debian networking
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>sudo systemctl enable systemd-networkd
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a># Enable systemd-resolved to replace the resolvconf service
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>sudo systemctl enable systemd-resolved
</code></pre></div>
<p>DNS resolvers for Linux are loaded from the <strong><code>/etc/resolv.conf</code></strong>. Rather than manage this directly or through <strong>resolvconf</strong>, we want to load resolvers dynamically from <strong>systemd-resolved</strong>. This is as simple as creating a link </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a># Set up a symbolic link from systemd-resolved resolv.conf to the system resolv.conf
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre></div>
<h3 id="update-wireless-service">Update Wireless Service<a class="headerlink" href="#update-wireless-service" title="Permanent link">&para;</a></h3>
<p>In order for <strong>wpa_supplicant</strong> to work correctly with <strong>networkd</strong>, one further change is needed. In our original configuration, we created a system-wide configuration file for wireless. This setup works just fine with the default networking setup, especially since the Pi is only equipped with one wireless interface by default. For <strong>networkd</strong> to work properly with <strong>wpa_supplicant</strong>, we need to attach our configuration directly to the <strong>wlan0</strong> interface as shown below.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a># Rename configuration as a per-interface file
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>sudo mv /etc/wpa_supplicant/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a># Enable the wpa_supplicant service specifically for wlan0
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>sudo systemctl enable wpa_supplicant@wlan0
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a># Disable the system-wide service
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>sudo systemctl disable wpa_supplicant
</code></pre></div>
<h2 id="test-your-configuration">Test Your Configuration<a class="headerlink" href="#test-your-configuration" title="Permanent link">&para;</a></h2>
<p>Call <strong><code>sudo reboot now</code></strong> to reboot the Pi. Log back in and verify that your Pi is fully operational:</p>
<ul>
<li>Confirm that your wireless interface is online</li>
<li><strong><code>cat /etc/resolv.conf</code></strong> to confirm that it is being populated by <strong>systemd-resolved</strong></li>
</ul>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="general-guidance">General Guidance<a class="headerlink" href="#general-guidance" title="Permanent link">&para;</a></h3>
<p>When logging back into your Pi, you may find that some of the functionality is failing. In addition to validating log files and checking that you completed all instructions, log files can provide valuable information for detecting where an error is occurring.</p>
<p>We have already mentioned <strong>journald</strong> earlier in this guide. In order to evaluate logs that are created by <strong>journald</strong>, we make use of the <strong><code>journalctl</code></strong> command. <a href="https://www.lifewire.com/what-to-know-less-command-4051972">Read up</a> on the <strong><code>less</code></strong> utility to learn how to efficiently navigate <strong><code>journalctl</code></strong> output.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a># Show log messages
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>journalctl
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a># Include messages marked secure
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>sudo journalctl
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a># Show messages from last boot
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>journalctl -k -b -1
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a># Show networkd messages
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>journalctl -u systemd-networkd
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a># Show resolved messages
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>journalctl -u systemd-resolved
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a># Show wpa_supplicant messages
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>journalctl -u wpa_supplicant
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a># Learn more about journald
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>man journalctl
</code></pre></div>
<h3 id="accessing-a-bricked-pi">Accessing a Bricked Pi<a class="headerlink" href="#accessing-a-bricked-pi" title="Permanent link">&para;</a></h3>
<p>If you made a mistake at the wrong point in the previous process, you may not even be able to connect anymore from the network. </p>
<p>If this happens, there are several ways to restore access:
- Contact instructor for a repair script. Raspberry Pi OS provides a mechanism to run a script during the boot process. You will need access to a microSD reader/writer in order to add the script into the boot folder.
- Connect a USB keyboard and HDMI monitor to the Pi in order to debug directly. You will need a micro-HDMI adapter. Most flat-screen TV's can be used as a monitor for this purpose.
- Use a serial console cable to access the Pi command line directly. Come to office hours or contact instructor for this option.
- Mount the SD card using a Linux virtual machine and repair the broken config files directly.</p>
<h3 id="rebuilding-raspberry-pi-os">Rebuilding Raspberry Pi OS<a class="headerlink" href="#rebuilding-raspberry-pi-os" title="Permanent link">&para;</a></h3>
<p>Alternatively, you may opt to reflash your memory card and repeat initial setup. Contact the instructor before proceeding. </p>
<p>If you find yourself in this position, the following recommendations will simplify the process:</p>
<ol>
<li>Copy a fully configured <strong><code>wpa_supplicant.conf</code></strong> to the <strong><code>boot</code></strong> volume of the memory card before the first boot. The boot process will move the file to the proper location in <strong><code>/etc/wpa_supplicant</code></strong> and set its permissions on the first boot.</li>
<li>Remove the previous server key hash from <strong><code>.ssh/known_hosts</code></strong> to prevent <strong><code>ssh</code></strong> from complaining about the Pi's new key.<ul>
<li><strong>macOS/Linux</strong> - Run <strong><code>ssh-keygen -R raspberrypi.local</code></strong></li>
<li><strong>Windows</strong> - Edit <strong><code>$HOME\.ssh\known_hosts</code></strong> and remove the lines that reference <strong><code>raspberrypi.local</code></strong> before you attempt to connect.</li>
</ul>
</li>
<li><strong>macOS/Linux</strong> - Run <strong><code>ssh-copy-id -i ~/.ssh/id_ed25519</code></strong> to quickly copy your public keys into <strong><code>authorized_keys</code></strong>. <em>Windows</em> users will have to manually set this file up as shown in previous guides.</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 Clinton Campbell</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
