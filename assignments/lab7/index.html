<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Clinton Campbell">
        <link rel="canonical" href="https://info314.tcpip.dev/assignments/lab7/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Lab 7 - proxy part 1 - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../pi-setup/">Raspberry Pi Setup</a>
</li>
            
<li >
    <a href="../networkd-setup/">networkd Setup</a>
</li>
            
<li >
    <a href="../../resources/wifi-reference/">Wifi Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../resources/address-planning/">IP Address Planning Reference</a>
</li>
            
<li >
    <a href="../dhcp-setup/">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../router-setup/">Router Setup</a>
</li>
            
<li >
    <a href="../../resources/iptables/">Introduction to iptables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../resolver-setup/">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../lab1/">Lab 1 - Core Technical Skills</a>
</li>
                                    
<li >
    <a href="../lab2/">Lab 2 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li >
    <a href="../lab3/">Lab 3 - Analyze Zeroconf in Wireshark</a>
</li>
                                    
<li >
    <a href="../lab4/">Lab 4 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li >
    <a href="../lab5/">Lab 5 - Analyze TCP with ncat and Wireshark</a>
</li>
                                    
<li >
    <a href="../lab6/">Lab 6 - Python and Socket Basics</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../notes/dns-overview/">Domain Name System (DNS)</a>
</li>
            
<li >
    <a href="../../notes/router-overview/">Routers</a>
</li>
            
<li >
    <a href="../../notes/ethernet-switches/">Ethernet Switches</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Guides</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../resources/pi-materials/">Getting Pi Materials</a>
</li>
            
<li >
    <a href="../../resources/digital-ocean/">Digital Ocean Signup</a>
</li>
            
<li >
    <a href="../../resources/address-planning/">Basic IP Address Planning</a>
</li>
            
<li >
    <a href="../../resources/iptables/">Introduction to Iptables</a>
</li>
            
<li >
    <a href="../../resources/netfilter-hooks/">Understanding Netfilter/Iptables Hooks</a>
</li>
            
<li >
    <a href="../../resources/wifi-reference/">Linux Wireless Configuration</a>
</li>
            
<li >
    <a href="../../resources/zone-file-format/">Zone File Reference</a>
</li>
            
<li >
    <a href="../../resources/vlans-and-dummies/">Special Network Interfaces (VLANs and Dummies)</a>
</li>
            
<li >
    <a href="../../resources/configure-routing-links/">Configuring Routing Links</a>
</li>
            
<li >
    <a href="../../resources/setup-frr/">Install Free Range Routing (FRR)</a>
</li>
            
<li >
    <a href="../../resources/ssh-agent/">Using ssh-agent</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Quick Reference</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../resources/markdown/">Intro to Markdown</a>
</li>
            
<li >
    <a href="../../resources/bash/">Intro to Bash</a>
</li>
            
<li >
    <a href="../../resources/host-config/">Mac/Win/Linux Networking</a>
</li>
            
<li >
    <a href="../../resources/wireshark-install/">Install Wireshark</a>
</li>
            
<li >
    <a href="../../resources/tshark-install/">Install TShark</a>
</li>
            
<li >
    <a href="../../resources/manage-dhcp/">Troubleshooting DHCP</a>
</li>
            
<li >
    <a href="../../resources/dns-clients/">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../contact/">Contact Us</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li>
                                <a href="https://github.com/quirktree/info314-website">quirktree/info314-website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#lab-7-proxy-part-1">Lab 7 - proxy part 1</a></li>
            <li><a href="#python-concepts">Python concepts</a></li>
            <li><a href="#instructions">Instructions</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="lab-7-proxy-part-1">Lab 7 - proxy part 1<a class="headerlink" href="#lab-7-proxy-part-1" title="Permanent link">&para;</a></h1>
<p><img alt="proxy image" src="https://hydrasky.com/wp-content/uploads/2017/10/proxy_diagram.png" /></p>
<p><a href="https://canvas.uw.edu/courses/1373089/assignments/5369624">Lab 7 Assignment page on Canvas</a></p>
<h2 id="python-concepts">Python concepts<a class="headerlink" href="#python-concepts" title="Permanent link">&para;</a></h2>
<ul>
<li>program structure</li>
<li>find(), split(), strip()</li>
<li>slicing lists / strings</li>
<li>try / except</li>
<li>dictionary</li>
<li>control characters, e.g., <code>\r\n</code></li>
</ul>
<h2 id="instructions">Instructions<a class="headerlink" href="#instructions" title="Permanent link">&para;</a></h2>
<h3 id="getting-started">Getting Started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h3>
<p>As always, create a new branch dedicated to this lab within your http-proxy repository, and at the root of your repository, add a new script named <code>http-proxy.py</code> based on <code>resources/template.py</code>. This file will be the main deliverable for your project.</p>
<p>HTTP proxies incorporate server and client functionality into a single daemon. As a server, your proxy listens and process the requests it receives from browsers and other HTTP clients. As a client, your proxy will pass the clients' requests on to the intended destination and handle the responses in return.</p>
<p>In this task, we will work exclusively on the server functionality of the proxy. Specifically, we'll build a server that processes the incoming TCP stream and parses out HTTP GET requests. In future assignments, we'll extend our code to handle other message types and implement the client functionality.</p>
<h3 id="main-loop-event-loop">Main Loop (Event Loop)<a class="headerlink" href="#main-loop-event-loop" title="Permanent link">&para;</a></h3>
<p>Use a while loop to repeatedly <code>accept()</code> and process incoming requests. For each active connection, you will be making calls to <code>Socket.recv()</code> in order to fetch the next chunk of data from the TCP stream and process it.</p>
<div class="admonition info">
<p class="admonition-title">What it means to work with streams</p>
<p>Remember that TCP is a stream-oriented protocol and that the Sockets API is built around the metaphor of the stream of bytes. Each attempt to read data from a socket pulls data from the stream in small chunks, e.g., <code>Socket.recv(1024)</code> returns <em>up to 1024 bytes</em> of data from the stream. </p>
<p>Don't assume that <code>recv()</code> will return a complete HTTP message in one call. The Sockets API does not even guarantee that it will return the full number of bytes you requested. In order to know where messages begin and end, we have to inspect the incoming bytes based on HTTP message syntax.</p>
</div>
<p>Since it is up to you to identify and reconstruct messages out of the stream, you should create a buffer that will hold your data while you work to identify complete HTTP messages. A buffer in this case is nothing more than a python bytes object that you append to each time a <code>recv()</code> returns successfully, for example:</p>
<div class="codehilite"><pre><span></span><span class="c1"># Declare an empty buffer</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

<span class="c1"># Receive new data and add it to the buffer</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">data</span>
</pre></div>

<h3 id="getting-to-http-messages">Getting to HTTP Messages<a class="headerlink" href="#getting-to-http-messages" title="Permanent link">&para;</a></h3>
<p>In order to recognize HTTP messages, you need to parse the bytes you've received and determine whether you have a complete message. Your task is to build a simple HTTP parser that accepts a byte buffer and attempts to parse an HTTP GET request (ignore other request types for now). We recommend that your parser returns the parsed message as a dictionary (see below) along with the bytes that were still left over in the buffer.</p>
<p>As noted, the data coming from the socket will be in bytestring format, meaning it will appear as <code>b'data'</code>  and not <code>'data'</code> as with a normal string. You cannot use string methods such as <code>split()</code> on a btyestring. Therefore you will need to decode the btyestring with the <code>str()</code> or <code>decode()</code> method to turn it into a string.</p>
<p>HTTP messages may be formatted as ASCII (per RFC 7230) or ISO-8859-1 (per historic RFCs). </p>
<p>Decoding text as <code>iso-8859-1</code> will allow for the maximum versatility.</p>
<p>Based on this description, we can create a python function that resembles the following:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">parse_message</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># initialize an empty dictionary</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># parse bytes and assign key / value pairs such as ...</span>
    <span class="n">message</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="c1"># HTTP method name such as GET</span>
    <span class="n">message</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="c1"># address or resource name from the request, such as www.uw.edu</span>
    <span class="n">message</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="c1"># HTTP version such as HTTP/1.0</span>
    <span class="n">message</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of headers</span>

    <span class="c1"># If parsing is successful, return a completed message (if applicable) and unused bytes</span>
    <span class="k">return</span> <span class="n">message</span><span class="p">,</span> <span class="n">unparsed_data</span>

    <span class="c1"># If parsing fails, return the entire buffer and an indicator that parsing was incomplete</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data</span>
</pre></div>

<h4 id="parsing">Parsing<a class="headerlink" href="#parsing" title="Permanent link">&para;</a></h4>
<p>HTTP messages follow a relatively simple syntax that can be used to make decisions about how to break the message into smaller parts (using tools like Python <em>slicing</em> and the functions <code>find()</code>, <code>strip()</code>, and <code>split()</code>). </p>
<p>For GET requests, the message structure is based entirely around lines and the <em>Carriage Return / New Line</em> line separators (think back to previous labs in which we sent GET requests using netcat). It's tempting for many students to read this and start parsing with a <code>data.split('\r\n')</code>. This strategy rarely works. </p>
<p>Instead, we recommend that you create a dedicated function to split a single line off the buffer. You can do this with <code>find()</code>, <code>strip()</code>, and <em>slices</em>.</p>
<p>Before you go any further, make sure you have a basic understanding of HTTP/1.0 message structure. See <a href="/assignments/proxy-labs">HTTP syntax overview</a> or <a href="https://tools.ietf.org/html/rfc1945">RFC 1945</a>.</p>
<h3 id="output">Output<a class="headerlink" href="#output" title="Permanent link">&para;</a></h3>
<p>After successfully parsing a request, you should print the following summary and close the connection (return to the start of your loop to listen for new requests).</p>
<p><strong>Request summary</strong></p>
<ul>
<li><strong>Connection Source:</strong> \&lt;IP address returned from the call to Socket.accept()></li>
<li><strong>HTTP Method:</strong> \&lt;Name of method, e.g., GET, OPTION, or POST></li>
<li><strong>Destination:</strong> \&lt;URI extracted from the request></li>
<li><strong>Headers:</strong> \&lt;Comma delimited list of header names>  </li>
</ul>
<h3 id="testing-your-code-with-testpy">Testing your code with <code>test.py</code><a class="headerlink" href="#testing-your-code-with-testpy" title="Permanent link">&para;</a></h3>
<p>The resources directory of the project repository contains a simple python script called test.py that you can use to send HTTP requests from a file into your proxy code.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Send the request from sample-request.txt </span>
<span class="c1"># one line at a time with a short delay between</span>
python3 test.py <span class="m">9999</span> sample-request.txt

<span class="c1"># Send the request from sample-request.txt 250 bytes at a time </span>
<span class="c1"># with a short delay between</span>
python3 test.py <span class="m">9999</span> sample-request.txt <span class="m">250</span>
</pre></div>

<h3 id="capturing-proxied-requests-for-testing">Capturing proxied requests for testing<a class="headerlink" href="#capturing-proxied-requests-for-testing" title="Permanent link">&para;</a></h3>
<p>Use the following method to capture valid requests that you can use for testing:</p>
<ul>
<li>Open ncat to listen for incoming connections, e.g., <code>ncat -o &lt;FILENAME&gt; -l &lt;PORT&gt;</code></li>
<li>Configure Firefox with an HTTP proxy on <code>127.0.0.1 &lt;PORT&gt;</code></li>
<li>Enter the URL of an HTTP-only site into the FF address bar (the request will hang)</li>
<li>Manually stop the request from the browser</li>
<li>Verify that the request was captured in ncat (ncat will close automatically)</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 Clinton Campbell</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
