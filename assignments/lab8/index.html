<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Clinton Campbell">
        <link rel="canonical" href="https://info314.tcpip.dev/assignments/lab8/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Proxy Part 2 (Lab 8) - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../pi-setup/">Raspberry Pi Setup</a>
</li>
            
<li >
    <a href="../networkd-setup/">networkd Setup</a>
</li>
            
<li >
    <a href="../../resources/wifi-reference/">Wifi Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../resources/address-planning/">IP Address Planning Reference</a>
</li>
            
<li >
    <a href="../dhcp-setup/">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../router-setup/">Router Setup</a>
</li>
            
<li >
    <a href="../../resources/iptables/">Introduction to iptables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../resolver-setup/">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Report - NAT and DNS Analysis</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../analysis-report/">Instructions</a>
</li>
            
<li >
    <a href="../../resources/tshark-install/">Installing TShark</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">5 - Configure an Authoritative Name Server</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../dns-zone-setup/">Authoritative Zone Setup</a>
</li>
            
<li >
    <a href="../../resources/zone-file-format/">DNS Zone Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Final WAN Project</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../final-project/">Project Requirements</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Extra Credit</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../vlan-challenge/">VLAN Challenge</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../lab1/">Lab 1 - Core Technical Skills</a>
</li>
                                    
<li >
    <a href="../lab2/">Lab 2 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li >
    <a href="../lab3/">Lab 3 - Analyze Zeroconf in Wireshark</a>
</li>
                                    
<li >
    <a href="../lab4/">Lab 4 - Analyze TCP with ncat and Wireshark</a>
</li>
                                    
<li >
    <a href="../lab5/">Lab 5 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li >
    <a href="../lab6/">Lab 6 - Socket Basics in Python</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Proxy Labs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../proxy-labs/">Proxy Project Overview</a>
</li>
            
<li >
    <a href="../lab7/">Proxy Part 1 (Lab 7)</a>
</li>
            
<li class="active">
    <a href="./">Proxy Part 2 (Lab 8)</a>
</li>
            
<li >
    <a href="../lab9/">Proxy Part 3 (Lab 9)</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../notes/dns-overview/">Domain Name System (DNS)</a>
</li>
            
<li >
    <a href="../../notes/router-overview/">Routers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Guides</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../resources/pi-materials/">Getting Pi Materials</a>
</li>
            
<li >
    <a href="../../resources/digital-ocean/">Digital Ocean Signup</a>
</li>
            
<li >
    <a href="../../resources/iptables/">Introduction to Iptables</a>
</li>
            
<li >
    <a href="../../resources/netfilter-hooks/">Understanding Netfilter/Iptables Hooks</a>
</li>
            
<li >
    <a href="../../resources/wifi-reference/">Linux Wireless Configuration</a>
</li>
            
<li >
    <a href="../../resources/zone-file-format/">Zone File Reference</a>
</li>
            
<li >
    <a href="../../resources/vlans-and-dummies/">Special Network Interfaces (VLANs and Dummies)</a>
</li>
            
<li >
    <a href="../../resources/configure-routing-links/">Configuring Routing Links</a>
</li>
            
<li >
    <a href="../../resources/setup-frr/">Install Free Range Routing (FRR)</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Quick Reference</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../resources/markdown/">Intro to Markdown</a>
</li>
            
<li >
    <a href="../../resources/bash/">Intro to Bash</a>
</li>
            
<li >
    <a href="../../resources/host-config/">Mac/Win/Linux Networking</a>
</li>
            
<li >
    <a href="../../resources/wireshark-install/">Install Wireshark</a>
</li>
            
<li >
    <a href="../../resources/tshark-install/">Install TShark</a>
</li>
            
<li >
    <a href="../../resources/manage-dhcp/">Troubleshooting DHCP</a>
</li>
            
<li >
    <a href="../../resources/dns-clients/">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../contact/">Contact Us</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../lab7/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../lab9/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/quirktree/info314-website">quirktree/info314-website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#lab-8-proxy-part-ii">Lab 8 - proxy part II</a></li>
            <li><a href="#python-concepts">Python concepts</a></li>
            <li><a href="#instructions">Instructions</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="lab-8-proxy-part-ii">Lab 8 - proxy part II<a class="headerlink" href="#lab-8-proxy-part-ii" title="Permanent link">&para;</a></h1>
<p><a href="https://canvas.uw.edu/courses/1373089/assignments/5369625">Lab 8 Assignment page on Canvas</a></p>
<h2 id="python-concepts">Python concepts<a class="headerlink" href="#python-concepts" title="Permanent link">&para;</a></h2>
<ul>
<li>Slicing lists / strings</li>
<li>Converting strings to/from numbers</li>
<li>Creating and using enumerations</li>
<li>Format strings, e.g., <code>"{}: {}\r\n".format(header_name, header_value)</code></li>
</ul>
<h2 id="instructions">Instructions<a class="headerlink" href="#instructions" title="Permanent link">&para;</a></h2>
<h3 id="getting-started">Getting Started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h3>
<p>As always, create a new branch dedicated to this lab within your http-proxy repository, and at the root of your repository, open up the <code>http-proxy.py</code> script you created in Lab 6 and continue working from the same file. </p>
<p>In the previous lab, we started to build the server component of your proxy. This component is designed to receive incoming requests from web clients and then eventually forward responses that were received from an upstream web server. The core of the server is established on a request parser, which we also started to develop in the last assignment.</p>
<p>In this lab, we'll extend the parser to handle additional HTTP request types and also HTTP responses. Likewise, we'll start to build out the client component of the proxy by writing a new function that rebuilds an HTTP request from a previously parsed message. </p>
<h3 id="parsing-requests-cont">Parsing Requests (cont.)<a class="headerlink" href="#parsing-requests-cont" title="Permanent link">&para;</a></h3>
<p>Extend your parsing function to handle more complex HTTP requests, such as the POST or PUT type. While GET requests are terminated by an empty CRLF line after the headers, other request types append an additional message body.</p>
<p>From a parsing perspective, a POST or PUT request proceeds exactly like the GET request up until reading the final CRLF that follows the header section. In order to read the remainder of the message, we need to first find out the length of the body component. In HTTP 1.0, the body length is defined by an HTTP header called <code>Content-Length</code>.<sup id="fnref:oversimplification"><a class="footnote-ref" href="#fn:oversimplification">1</a></sup> The value of <code>Content-Length</code> will be a numeric string that defines the length of the body payload. If the header exists and its integer value is non-zero, you should attempt to read <em>Content-Length</em> bytes from the buffer and save as an additional field in your parsed message. </p>
<p>If you succeed in parsing a complete message, you should remove the data from the buffer and return a dictionary containing the parts of your message back to the main event loop. If parsing fails, you should leave the data in the buffer and return to your connection handling loop to wait for the rest of the message.</p>
<h3 id="parsing-responses">Parsing Responses<a class="headerlink" href="#parsing-responses" title="Permanent link">&para;</a></h3>
<p>Structurally, there is almost no difference between an HTTP request with a message body and an HTTP response. In fact, the only difference from your parser's perspective is the order of fields in the first line of the message.<sup id="fnref:http-syntax"><a class="footnote-ref" href="#fn:http-syntax">2</a></sup></p>
<p>Extend your parser to handle both types of messages based on an additional <code>message_type</code> argument to your parser function. Modify the behavior of the function to parse the first line properly based on this argument, include the <code>message_type</code> in the parsed message.</p>
<p>A standard way to represent a value representing a message type is using an enumeration, e.g.:</p>
<div class="codehilite"><pre><span></span><span class="c1"># Required imports</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>

<span class="c1"># Enumeration to represent message types </span>
<span class="k">class</span> <span class="nc">MessageType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">REQUEST</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">RESPONSE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

<span class="c1"># Use the is operator rather than == to test an enumeration …</span>
<span class="c1"># if message[‘type’] is MessageType.REQUEST:</span>
</pre></div>

<h3 id="build-message">Build Message<a class="headerlink" href="#build-message" title="Permanent link">&para;</a></h3>
<p>Before you wrap up this lab, let's create one more component of the parser, a new function that takes a dictionary like the one generated by your parser and builds a new message (returning the message as a byte string).<sup id="fnref:really?"><a class="footnote-ref" href="#fn:really?">3</a></sup> </p>
<p>The message you build should be modified in the following manner:</p>
<ul>
<li>Replace the HTTP version you received with <code>HTTP/1.0</code></li>
<li>Add or update a <code>Via</code> header (per RFC 7230) for the proxied connection, e.g.,<ul>
<li><code>Via: 1.0 127.0.0.1:9999</code></li>
<li>If a <code>Via</code> already exists, append your entry as a comma separated value to the end of the existing header</li>
</ul>
</li>
</ul>
<h4 id="tips">Tips<a class="headerlink" href="#tips" title="Permanent link">&para;</a></h4>
<ul>
<li>Use python format strings to recreate the line-delimited parts of the message, ensuring you terminate each line in <code>\r\n</code> and encode as <code>iso-8859-1</code></li>
</ul>
<h3 id="output">Output<a class="headerlink" href="#output" title="Permanent link">&para;</a></h3>
<p>Once all parts of your code are working, print the following summary and close the connection. This will return to the start of your loop to listen for new connections).</p>
<p><strong>Request summary</strong>  </p>
<ul>
<li>Connection Source: &lt; IP address returned from the call to Socket.accept() &gt;  </li>
<li>HTTP Method: &lt; Name of method, e.g., GET, OPTION, or POST  &gt;  </li>
<li>Destination: &lt; URI extracted from the request &gt;  </li>
<li>Headers: &lt; Comma delimited list of header names &gt;</li>
</ul>
<p><strong>Ready to forward Request</strong></p>
<ul>
<li>Target: &lt; URI of server obtained from request &gt;</li>
<li>Message: &lt; Raw bytes of the rebuilt request &gt;</li>
</ul>
<details class="note"><summary> What are these diamonds "&lt;   &gt;" ?</summary><p>These are placeholders. When you see these it means you should fill in information that is between them and then delete the symbols. It's a quick way of saying "hey something needs to be filled in" for the developer world.</p>
</details>
<h3 id="testing-your-code-with-testpy">Testing your code with test.py<a class="headerlink" href="#testing-your-code-with-testpy" title="Permanent link">&para;</a></h3>
<p>The resources directory of the project repository contains a simple
python script called test.py that you can use to send HTTP requests from
a file into your proxy code.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Send the request from sample-request.txt on port 9999 one line at a time with a short delay between</span>
<span class="n">python3</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span> <span class="mi">9999</span> <span class="n">sample</span><span class="o">-</span><span class="n">request</span><span class="o">.</span><span class="n">txt</span>

<span class="c1"># Send the request from sample-request.txt on port 9999 250 bytes at a time with a short delay between</span>
<span class="n">python3</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span> <span class="mi">9999</span> <span class="n">sample</span><span class="o">-</span><span class="n">request</span><span class="o">.</span><span class="n">txt</span> <span class="mi">250</span>
</pre></div>

<h3 id="capturing-proxied-requests-for-testing">Capturing proxied requests for testing<a class="headerlink" href="#capturing-proxied-requests-for-testing" title="Permanent link">&para;</a></h3>
<p>Use the following method to capture valid requests that you can use for
testing:</p>
<ul>
<li>Open ncat to listen for incoming connections, e.g., <code>ncat -o &lt;FILENAME&gt; -l &lt;PORT&gt;</code></li>
<li>Configure Firefox with an HTTP proxy on <code>127.0.0.1 &lt;PORT&gt;</code></li>
<li>Enter the URL of an HTTP-only site into the FF address bar (the request will hang)</li>
<li>Manually stop the request from the browser</li>
<li>Verify that the request was captured in ncat (ncat will close automatically)</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:oversimplification">
<p>This is an oversimplification of the RFC for HTTP/1.0, but it will be sufficient
for our purposes.&#160;<a class="footnote-backref" href="#fnref:oversimplification" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:http-syntax">
<p>More information available at <a href="/assignments/proxy-labs">HTTP syntax overview</a>&#160;<a class="footnote-backref" href="#fnref:http-syntax" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:really?">
<p>I realize it seems strange to rebuild the message you just spent time tearing apart, but this approach gives you more leverage in terms of what functions your proxy can provide. For example, notice how easily we can modify the HTTP version and add new headers.&#160;<a class="footnote-backref" href="#fnref:really?" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 Clinton Campbell</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
